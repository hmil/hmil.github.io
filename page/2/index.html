<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>hmil&#39;s blog</title>
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <div class="container">
    <nav class="main-nav">
    <div class="site-title">hmil</div>
    <div class="sep"></div>
    <a href="/">Blog</a>
    <a target="_blank" rel="noopener" href="https://hmil.fr/">About</a>
</nav>
    
    <article id="post-archive/you-should-worry-about-vary" class="article article-type-post" itemscope
    itemprop="blogPost">
    <div class="article-meta">
        
        
    </div>
    <div class="article-inner">
        
        
            <header class="article-header">
                
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/archive/you-should-worry-about-vary/">You should worry about Vary</a>
    </h1>
  

                <time datetime="2016-10-16T01:49:15.000Z" itemprop="datePublished">October 16, 2016</time>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
            
                <p>We’ve all heard of XSS, SQLi and CSRF. And although they keep occurring all the time, any decent web framework nowadays has some mechanisms to avoid those. Now did you know CSRF had a little sister? It is so poorly known that it seems like it doesn’t even have its own name! Before explaining how it works, let’s see what it can do.</p>
<h1 id="Some-background"><a href="#Some-background" class="headerlink" title="Some background"></a>Some background</h1><p>Meet Bob, a web dev who is in charge of writing a public facing API. Bob sets the Access-Control-Allow-Origin header to allow all origin domains. Indeed, Bob wants any website to be able to talk to his API. Now, being a thoughtful developer, Bob knows about <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet" target="_blank" rel="noopener">CSRF</a> and he builds an authentication mechanism that delivers access tokens. Without a proper access token, his API won’t talk!</p>
<p>Still following? Good, now you may be wondering what this API does. In fact this API allows different services to store and share credentials in the cloud. The way a service gets the credentials is by issuing a request like this one:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /vault/&#123;account&#125;/&#123;service&#125;</span><br><span class="line">Authorization: Basic QWxhZGRpbjpPcGVuU2VzYW1l</span><br></pre></td></tr></table></figure></p>
<p>Bob heard one day that Auth basic is unbreakable, therefore he is using this method to pass the API key and username.<br>But the backend is doing some crypto stuff and hence requesting the credentials is an expensive operation. Bob adds some Cache-Control information to tell the browser to cache the response for a little bit. This way Bob reduces the load on his server and improves the speed of apps consuming his API.<br>If the credentials check out, the API returns something like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">200 OK</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Access-Control-Allow-Headers: Authorization</span><br><span class="line">Cache-Control: no-transform, max-age=600</span><br><span class="line">Content-Length: 42</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;&quot;username&quot;:&quot;Alice&quot;,&quot;password&quot;:&quot;I4mab055&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>Everything works fine until one day, a client complains that her credentials got stolen…<br>Damn it Bob, again?!</p>
<h1 id="You-just-got-hit"><a href="#You-just-got-hit" class="headerlink" title="You just got hit"></a>You just got hit</h1><p>Bob can check his server log for a while, he will never find anything. The attacker left no evidence behind because he <strong>never even had to talk to Bob’s API</strong>; Everything happened locally, in Alice’s browser. Alice received this stupid email a few days ago and couldn’t resist opening a link to a picture of a <a href="https://i.reddituploads.com/3a16089469a04fe2bec7c3666b3bf169?fit=max&amp;h=1536&amp;w=1536&amp;s=6160f4d2e6b39bb1c1684416878ec2dc" target="_blank" rel="noopener">cat wearing a ninja-turtle mask</a>.<br>While she was watching this picture, a piece of javascript issued an HTTP request in the background to Bob’s API and stole her credentials. But how did the malicious website get an API token in the first place you’ll ask? Well it didn’t. Because it never had to. <strong>A simple request without the Authorization header was enough to get the information.</strong></p>
<h1 id="Introducing-Vary"><a href="#Introducing-Vary" class="headerlink" title="Introducing: Vary"></a>Introducing: Vary</h1><p>So there’s this thing in the HTTP spec that you may or may not have heard about. It’s called the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Vary" target="_blank" rel="noopener">Vary</a> header. What it does is inform any cache about which request headers can cause the response to change. <strong>If the Vary header is omitted, then caches will disregard the request headers when deciding whether to serve the response from cache.</strong> In other words, no matter which headers were sent by the client the first time, the response will be cached and served back to every subsequent request until the response expires, regardless of the next request’s headers. Remember how Bob made the response cacheable for 10 minutes? This means that the attack is successful if it happens within 10 minutes of the original request.</p>
<p>To prevent this issue, the API should send the <em>Vary</em> header in its responses to inform caches that the response will be different for different values of the <em>Authorization</em> header. In our example we get:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">200 OK</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Access-Control-Allow-Headers: Authorization</span><br><span class="line">Cache-Control: no-transform, max-age=600</span><br><span class="line">Content-Length: 42</span><br><span class="line">Content-Type: application/json</span><br><span class="line">**Vary: Authorization**</span><br><span class="line"></span><br><span class="line">&#123;&quot;username&quot;:&quot;Alice&quot;,&quot;password&quot;:&quot;I4mab055&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Going-beyond"><a href="#Going-beyond" class="headerlink" title="Going beyond"></a>Going beyond</h1><p>So stealing information is fun but let’s see if we can use this flaw to do something better. Imagine a web page that allows a user to set a message of the day, stores it in the cookies and displays it whenever the user visits the page for the rest of the day. The page is cached and can be fetched cross-domain just like in the previous example and it doesn’t have <em>Vary: Cookie</em>. If a user visits my website, I could issue a request to the greetings page with a custom Cookie. If I manage to perform this request when the page is not in cache yet, then the browser will fetch the page with my custom cookie and store it. Yes, we just found ourselves a cache-poisoning vulnerability. Now guess what happens next if this page allows the greeting message to contain javascript?</p>
<p>Depending on the cache headers, it may even be possible that the response gets cached on a server sitting between the victim and the origin. In this situation the attacker can read the victim’s data without even running code in her browser! All that is required is a hit on the cache server.</p>
<h1 id="Wrapping-up"><a href="#Wrapping-up" class="headerlink" title="Wrapping up"></a>Wrapping up</h1><p>I wish this article will at least allow a few people to get awareness about the dangers associated with Cache-Control and the Vary header. This vulnerability is similar to CSRF in that it allows cross domain requests to do some damage. It is harder to exploit and does not allow to reach the server. This however makes it impossible to detect attacks while still allowing some information leakage and defacing. In the case of cache poisoning, it opens up the attacks surface to find other vulnerabilities such as XSS or even SQL injections.</p>
<p>The fact that this vulnerability lies in the shadow of the big names like XSS makes it more likely to be looked over. In fact it <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-1418" target="_blank" rel="noopener">has occurred before</a> and I bet there are exploitable scenarios in the wild like those discussed above. So be careful next time you build an API and take some time to review your response headers. It can sometimes be trickier than you’d think figuring out which headers make the response change!</p>
<p>You may want to try out <a href="https://github.com/hmil/invariable-leak" target="_blank" rel="noopener">this quick and dirty proof of concept</a> to see this flaw in action.</p>

            
        </div>
        
    </div>
    
</article>


    <hr />

    <article id="post-archive/githubs-merge-pull-request-is-wrong" class="article article-type-post" itemscope
    itemprop="blogPost">
    <div class="article-meta">
        
        
    </div>
    <div class="article-inner">
        
        
            <header class="article-header">
                
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/archive/githubs-merge-pull-request-is-wrong/">GitHub&#39;s &#34;merge pull request&#34; is wrong</a>
    </h1>
  

                <time datetime="2015-11-21T13:49:06.000Z" itemprop="datePublished">November 21, 2015</time>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
            
                <p>This is the story of Bob. Bob is working on some cool project on github. He’s written tests and runs them continuously on <a href="https://travis-ci.org" target="_blank" rel="noopener">travis</a>. Bob asks his contributors to write tests for new features they introduce. Using GitHub’s pull requests, he can make sure no bugs are introduced by looking for the green tick next to the commit number. If you look at the commit tree in Bob’s repository, you’ll probably find something like <a href="http://nvie.com/posts/a-successful-git-branching-model/" target="_blank" rel="noopener">this</a>.</p>
<p>Bob states in his contribution guide that people can fork <em>master</em> to work on new features. He guarantees that master’s tests always pass and therefore, individual contributors don’t need to worry that much about errors made by other developers.</p>
<p>If you’re familiar with github then you are probably familiar with this workflow and you’ll think that it’s perfectly reasonable.</p>
<p>But you’ll be wrong. Bob got overly enthusiastic about github’s UI and will soon discover that <strong>he’s been wrong all this time</strong>.</p>
<h2 id="A-catastrophic-scenario"><a href="#A-catastrophic-scenario" class="headerlink" title="A catastrophic scenario"></a>A catastrophic scenario</h2><p>Say two contributors, Alice and Charlie, are writing code for Bob’s project in their respective branches. In this project, we find the following code for operating Bob’s car:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">(String action)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"OPEN_DOOR"</span>:</span><br><span class="line">       open_door();</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Now Alice thinks it would be better if Bob used an <strong>enum</strong> instead of a string. She changes the function to the following and opens a pull request on Bob’s project.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">(Action action)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">    <span class="keyword">case</span> Action.OPEN_DOOR:</span><br><span class="line">       open_door();</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Bob opens his project page and sees a pull request. He thinks Alice’s modification makes sense and, since all tests passed, he clicks on <em>the green button</em>.</p>
<p>[caption id=”attachment_221” align=”alignnone” width=”776”]<a href="/assets/archive/2015/11/button_of_doom.png"><img src="/assets/archive/2015/11/button_of_doom.png" alt="The button of doom"></a> The button of doom[/caption]</p>
<p>Meanwhile, Charlie thinks Bob will need to close his car’s door at some point. Charlie adds a new case to the switch:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">(String action)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"OPEN_DOOR"</span>:</span><br><span class="line">       open_door();</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"CLOSE_DOOR"</span>:</span><br><span class="line">       close_door();</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The next day, Bob opens his project on GitHub and sees Charlie’s pull request. All tests passed, no merge conflict, that’s a clear <acronym title="Looks Good To Me">LGTM</acronym> and Bob merges the code.</p>
<p>A few days later, Bob receives complaints from multiple developers, they forked master and it doesn’t build!</p>
<h2 id="What-could-go-wrong"><a href="#What-could-go-wrong" class="headerlink" title="What could go wrong?"></a>What could go wrong?</h2><p>The problem lies in a common misunderstanding of the following assumptions. </p>
<ul>
<li>Different PRs must be completely independent</li>
<li>No merge conflicts &ne; No conflicts</li>
</ul>
<p>If you accept one of these to be violated, then expect your main branch to fail tests!</p>
<p>If we speak in terms of diff, then Alice’s diff is the following:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">(String action)</span> </span>&#123;</span><br><span class="line">+ <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">(Action action)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">-     <span class="keyword">case</span> <span class="string">"OPEN_DOOR"</span>:</span><br><span class="line">+     <span class="keyword">case</span> Action.OPEN_DOOR:</span><br><span class="line">         open_door();</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>While Bob’s diff looks like this:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">+     <span class="keyword">case</span> <span class="string">"CLOSE_DOOR"</span>:</span><br><span class="line">+        close_door();</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>Put together we get<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">(String action)</span> </span>&#123;</span><br><span class="line">+ <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">(Action action)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">-     <span class="keyword">case</span> <span class="string">"OPEN_DOOR"</span>:</span><br><span class="line">+     <span class="keyword">case</span> Action.OPEN_DOOR:</span><br><span class="line">         open_door();</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">+     <span class="keyword">case</span> <span class="string">"CLOSE_DOOR"</span>:</span><br><span class="line">+        close_door();</span><br><span class="line">+        <span class="keyword">break</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>This diff <strong>does not cause a merge conflict</strong> but it is actually in conflict!</p>
<h2 id="–no-ff-and-the-button-of-doom"><a href="#–no-ff-and-the-button-of-doom" class="headerlink" title="–no-ff and the button of doom"></a>–no-ff and the button of doom</h2><p>The flaw resides in that big old “merge pull request” button. While the green checks above the button and its fat style make pressing it a rewarding thing, it hides the real danger behind it: a blind merge!</p>
<p>The above example looks like this in terms of commit history:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">       +-PR_Charlie-+</span><br><span class="line">      /              \</span><br><span class="line">     +--PR_Alice--+   \</span><br><span class="line">    /              \   \</span><br><span class="line">---+----------------x---x</span><br><span class="line">                        |</span><br><span class="line">                       master</span><br></pre></td></tr></table></figure></p>
<p>All changes introduced by Alice and Charlie on their respective PRs have been tested, but the merge commits (marked ‘x’ above) were not! This is called a “non fast-forward” merge (–no-ff in git) and is basically like committing directly on master.</p>
<h2 id="The-right-way-to-do-it"><a href="#The-right-way-to-do-it" class="headerlink" title="The right way to do it"></a>The right way to do it</h2><p>Assuming you are like Bob and want your main branch to always pass tests, then here is the right way to do this: Merge master into the PR fisrt, and merge only when fast forward. It would look like that:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">Initial state: both PRs are unmerged:</span><br><span class="line"></span><br><span class="line">        +-PR_Charlie-+</span><br><span class="line">       /              </span><br><span class="line">      +--PR_Alice--+  </span><br><span class="line">     /                 </span><br><span class="line"> ---+</span><br><span class="line">    |</span><br><span class="line">  master</span><br><span class="line"></span><br><span class="line">on master: git merge --ff-only PR_Alice</span><br><span class="line"></span><br><span class="line">      +-PR_Charlie-+</span><br><span class="line">     /                              </span><br><span class="line"> ---+--PR_Alice--+</span><br><span class="line">                 |</span><br><span class="line">               master</span><br><span class="line"></span><br><span class="line">on PR_Charlie: git merge master</span><br><span class="line"></span><br><span class="line">                  merge branch master into PR_Charlie   </span><br><span class="line">                     |</span><br><span class="line">      +-PR_Charlie-+-+</span><br><span class="line">     /              /                  </span><br><span class="line"> ---+--PR_Alice----+</span><br><span class="line">                   |</span><br><span class="line">                 master</span><br><span class="line"></span><br><span class="line">Then on master: git merge --ff-only PR_Charlie</span><br><span class="line"></span><br><span class="line">      +-PR_Charlie-+</span><br><span class="line">     /              \                  </span><br><span class="line"> ---+--PR_Alice----+-+</span><br><span class="line">                     |</span><br><span class="line">                   master</span><br></pre></td></tr></table></figure>
<p>The end result is exactly the same as before EXCEPT that master was merged into the PR first, and this (if properly pushed to github) allows the automated tools to test the last commit. This ensures that master builds because master will always be on a commit that has been tested before.</p>
<p>Many beginner (and even advanced) programmers get fooled into thinking that merging a green pull request cannot harm. In an ideal world, clicking the green button would: merge master into the branch, wait for the tests to pass, and on success, fast-forward master to the merge commit. But unfortunately I don’t think this is coming anytime soon. In the meantime, think about it twice before you press the <em>button of doom</em>. And when in doubt, run the merge sequence manually in the right order. This may save you a few hours of debugging.</p>

            
        </div>
        
    </div>
    
</article>


    <hr />

    <article id="post-00-hacking-funrun2-how-to-reverse-engineer-a-corona-app" class="article article-type-post" itemscope
    itemprop="blogPost">
    <div class="article-meta">
        
        
    </div>
    <div class="article-inner">
        
        
            <header class="article-header">
                
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/00-hacking-funrun2-how-to-reverse-engineer-a-corona-app/">Hacking FunRun2 — how to reverse engineer a Corona app</a>
    </h1>
  

                <time datetime="2015-02-13T16:27:12.000Z" itemprop="datePublished">February 13, 2015</time>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
            
                <p><strong>Disclaimer:</strong> This article is a bit old and does not apply to recent versions of the corona sdk. It is put here <strong>for educational purpose</strong>, showing how one may try to break into this kind of applications. <strong>It is not a magic formula for hacking all corona apps across all versions of the sdk.</strong></p>
                
            
        </div>
        
    </div>
    
</article>


    <hr />

    <article id="post-archive/sailsjs-tutorial-expenses-tracking-app-part-4" class="article article-type-post" itemscope
    itemprop="blogPost">
    <div class="article-meta">
        
        
    </div>
    <div class="article-inner">
        
        
            <header class="article-header">
                
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-4/">SailsJS tutorial &amp;#124; expenses tracking app (Part 4/4)</a>
    </h1>
  

                <time datetime="2014-12-18T16:22:14.000Z" itemprop="datePublished">December 18, 2014</time>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
            
                <p><a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-3" target="_blank" rel="noopener">In the previous parts</a>,<br>we’ve set up a sails application, added some styles and views and implemented a solid backend. It’s now time to finish this application. We will implement the front-end, adjust a few settings and give some tracks to continue the development.</p>
<h2 id="The-app-page"><a href="#The-app-page" class="headerlink" title="The app page"></a>The app page</h2><p>To render our app page, let’s open the MainController (in <em>api/controllers</em>) and replace the contents of the app action with<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">app: function (req, res) &#123;</span><br><span class="line">  res.view();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>What this does is it renders the view <em>views/main/app.ejs</em> because we are in the app action of the MainController. You should have already added this view in <a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-2" target="_blank" rel="noopener">part 2</a>.</p>
<p>Next we only want logged-in users to access our app so let’s add the following lines in <em>config/policies.js</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">MainController: &#123;</span><br><span class="line">  <span class="string">'app'</span>: [<span class="string">'passport'</span>, <span class="string">'sessionAuth'</span>]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>Also we want some more information about our users than we currently get, like their profile picture and full name. To do this, we’ll need to hack a bit into what sails-generate-auth generated us. Open <em>api/services/passport.js</em>, line 82 there’s the code fetching user attributes</p>
<p><pre lang="javascript" line="82"><br>  // If the profile object contains a list of emails, grab the first one and<br>  // add it to the user.<br>  if (profile.hasOwnProperty(‘emails’)) {<br>    user.email = profile.emails[0].value;<br>  }<br>  // If the profile object contains a username, add it to the user.<br>  if (profile.hasOwnProperty(‘username’)) {<br>    user.username = profile.username;<br>  }</pre></p>
<p>  // If neither an email or a username was available in the profile, we don’t<br>  // have a way of identifying the user in the future. Throw an error and let<br>  // whoever’s next in the line take care of it.<br>  if (!user.username &amp;&amp; !user.email) {<br>    return next(new Error(‘Neither a username nor email was available’));<br>  }</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">**Remove all this** and insert this instead:</span><br><span class="line">&lt;pre lang=&quot;javascript&quot; line=&quot;82&quot;&gt;</span><br><span class="line">  if (!profile.hasOwnProperty(&apos;id&apos;) </span><br><span class="line">      || !profile.hasOwnProperty(&apos;displayName&apos;)</span><br><span class="line">      || !profile.hasOwnProperty(&apos;photos&apos;)</span><br><span class="line">      || profile.photos.length == 0 ) &#123;</span><br><span class="line">    sails.log.error(&apos;not enough info&apos;);</span><br><span class="line">    next(new Error(&apos;Your login provider did not provide enough information.&apos;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  user.username = profile.displayName;</span><br><span class="line">  user.picture = profile.photos[0].value;</span><br></pre></td></tr></table></figure>
<h2 id="Scripting"><a href="#Scripting" class="headerlink" title="Scripting"></a>Scripting</h2><p>This tutorial aims to be neutral regarding what client technology you use, therefore we we’ll do DOM stuff “manually” with jquery and only use backbone and underscore to have a tidy collection of expenditures. You’ll be able to follow even if you’ve never heard of backbone.</p>
<p>First, <a href="http://hmil.fr/public/sails_tuto_1.zip" target="_blank" rel="noopener">download this archive</a>. It contains templates, js models and libs as well as a skeleton for our app script. Copy the assets into your assets folder.<br>You can lift your server and log-into the app. You should see a blank table. Now open your web console and it should display some errors. This is due to the fact that the script you just copied are linked to the layout in no particular order. You can see this by looking at <em>views/layout.ejs</em>.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;!--SCRIPTS--&gt;</span><br><span class="line">&lt;script src=<span class="string">"/js/dependencies/sails.io.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/dependencies/backbone.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/dependencies/bootstrap.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/dependencies/jquery-1.11.1.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/dependencies/perfect-scrollbar.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/dependencies/underscore.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/ExpenditureModel.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/app.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;!--SCRIPTS END--&gt;</span><br></pre></td></tr></table></figure></p>
<p>Here, backbone and bootstrap are included after jquery and underscore. To correct this, let’s take a look at <em>tasks/pipeline.js</em>. We will change <em>jsFilesToInject</em> such that our js files are included in the right order:</p>
<p><pre lang="javascript" line="24"><br>var jsFilesToInject = [<br>  // Underscore &amp; jquery before backbone<br>  ‘js/dependencies/jquery-1.11.1.js’,<br>  ‘js/dependencies/perfect-scrollbar.js’,<br>  ‘js/dependencies/underscore.js’,</pre></p>
<p>  // Dependencies like jQuery, or Angular are brought in here<br>  ‘js/dependencies/*<em>/</em>.js’,</p>
<p>  // The app classes before the app index<br>  ‘js/ExpenditureModel.js’,</p>
<p>  // All of the rest of your client-side js files<br>  // will be injected here in no particular order.<br>  ‘js/app.js’<br>];</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">While we are here, change _templateFilesToInject_ such that it looks for **.ejs** files instead of **.html**.</span><br><span class="line">&lt;pre lang=&quot;javascript&quot; line=&quot;51&quot;&gt;</span><br><span class="line">var templateFilesToInject = [</span><br><span class="line">  &apos;templates/**/*.ejs&apos;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>Save this file and if sails was running in background, the build tasks should run and now our js files should be included in the right order and our templates are compiled.</p>
<p>Now, let’s write real code. Open <em>assets/js/app.js</em>. This file contains already everything we need to handle the DOM of the page. What we’ll focus on is how to get data from the server and keep it in sync using Sails’ real-time capabilities. For simplicity we’ll do everything over the socket connection so that we don’t mix protocols.</p>
<p>We have a backbone expenditure collection that we’ll use to store our expenditures locally and propagate events.</p>
<p>First thing we’ll do is fetch a list of expenditures from the server. This is what <em>io.socket.get</em> is for.<br>Let’s add those models to our collection as soon as we get them.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">io.socket.get(<span class="string">'/expenditure'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">models</span>) </span>&#123;</span><br><span class="line">  expenditures.set(models, &#123;<span class="attr">parse</span>: <span class="literal">true</span>&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>We pass the <em>parse: true</em> option to turn the date string into an actual date object.<br>Add some expenditures with the shortcut routes (for instance <a href="http://localhost:1337/expenditure/create?amount=32&amp;description=resto" target="_blank" rel="noopener">/create?amount=32&amp;description=resto</a>) and now you should see them displayed in the table like this:</p>
<p><a href="/assets/archive/2014/12/sails-tuto-capture.png"><img src="/assets/archive/2014/12/sails-tuto-capture.png" alt="Yay, we got some data !"></a><br><em>If you can’t see the picture, that’s probably because you created a user before we told passport to get profile pictures of new users. Stop the server, delete <em>.tmp/localDiskDb.db</em>, then start the server again. Next time you log in, it will create a user from scratch and now your profile picture should be included with it.</em></p>
<p>Now it would be better if we could add expenditures directly from the app. We can insert the code that handles the create form submit action on line 58.</p>
<p><pre lang="javascript" line="58"><br>createForm.submit(formAction(createForm, function(formData) {<br>  io.socket.post(‘/expenditure’, formData, function(data, res) {<br>    if (res.statusCode === 201) {<br>      expenditures.add(new expenditures.model(data, {parse: true}));<br>    } else {<br>      console.log(data);<br>    }<br>  });<br>}));</pre></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Here we use the _post_ method of our socket to create the model, then we check the status code and create a new model if everything went fine. If there was an error, we just log the response body. It would be better to have a proper error handling mechanism of course but we won&apos;t do that in this tutorial.</span><br><span class="line"></span><br><span class="line">You can now see that our models are added to the collection and if you refresh they are still there. Good, now if you open a second tab it won&apos;t automatically update one tab while you add a model in the other. To do this, we need to fill the blank on line 23.</span><br><span class="line">This callback is invoked every time something changes in our expenditures collection. The passed-in _evt_ object has a _verb_ property which can take one of &quot;created&quot;, &quot;destroyed&quot;, &quot;updated&quot; values.</span><br><span class="line">With a simple switch, we can handle each of these cases:</span><br><span class="line">```javascript</span><br><span class="line"></span><br><span class="line">io.socket.on(&apos;expenditure&apos;, function(evt) &#123;</span><br><span class="line">  switch (evt.verb) &#123;</span><br><span class="line">    case &apos;created&apos;:</span><br><span class="line">      expenditures.add(evt.data, &#123;parse: true&#125;);</span><br><span class="line">      break;</span><br><span class="line">    case &apos;destroyed&apos;:</span><br><span class="line">      expenditures.remove(evt.id);</span><br><span class="line">      break;</span><br><span class="line">    case &apos;updated&apos;:</span><br><span class="line">      var data = _.extend(&#123;id: evt.id&#125;, evt.data)</span><br><span class="line">      expenditures.set(data, &#123; </span><br><span class="line">        parse: true, </span><br><span class="line">        remove: false </span><br><span class="line">      &#125;);</span><br><span class="line">      break;</span><br><span class="line">    default:</span><br><span class="line">      throw new Error(&quot;Unknown verb: &quot;+evt.verb);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>That’s all we need to make our app real-time !</p>
<p>Now how about deleting items. We have an event handler for that on what should now be line 48 and I think you’ve guessed what we’ll write here.</p>
<p><pre lang="javascript" line="48"><br>io.socket.delete(‘/expenditure/‘+id, function(data, res) {<br>  if (res.statusCode === 200) {<br>    expenditures.remove(id);<br>  } else {<br>    console.log(data);<br>  }<br>});</pre></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">And last but not least, we want to edit our records. This is done by clicking the edit icon which shows up a dialog. We need to write what happens when this dialog is submitted.</span><br><span class="line"></span><br><span class="line">```javascript</span><br><span class="line"></span><br><span class="line">$(&apos;#editModal-accept-btn&apos;).click(itemAction(function(evt) &#123;</span><br><span class="line">// Retrieve form data</span><br><span class="line">var formData = getFormData(editForm);</span><br><span class="line">var id = editedItem.id;</span><br><span class="line"></span><br><span class="line">// Save to the server</span><br><span class="line">io.socket.put(&apos;/expenditure/&apos;+id, formData, function(data, res) &#123;</span><br><span class="line">  // If successful</span><br><span class="line">  if (res.statusCode === 200) &#123;</span><br><span class="line">    // update the collection locally</span><br><span class="line">    var data = _.defaults(&#123;id: id&#125;, data);</span><br><span class="line">    expenditures.set(</span><br><span class="line">      data, </span><br><span class="line">      &#123;parse: true, remove: false&#125;</span><br><span class="line">    );</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    console.log(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>Congratulations, you now have a fully functionnal app !</strong></p>
<p>Now if you log-in as another user, the edit and delete actions are shown on expenditures you did not create. Of course, the server forbids this but it would be better if they were hidden. To do this, we’ll need to know which client is currently connected from the client-side javascript. The easiest way to do it is by adding a script in layout.ejs which injects a user object for the logged-in user in the client’s javascript scope. We need to be careful though as layout can be displayed even when the user is not logged in. Add this in <em>views/layout.ejs</em> right before the other scripts.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">  <span class="keyword">var</span> user = <span class="xml"><span class="tag">&lt;<span class="name">%-</span> <span class="attr">JSON.stringify</span>(<span class="attr">req.user</span>) || '<span class="attr">null</span>' %&gt;</span>;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>Now we can use this client object in our client-side scripts. Let’s edit <em>assets/templates/expenditureItem.ejs</em>, we will wrap the actions in an if statement like this:</p>
<p><pre lang="javascript" line="14"><br>&lt;% // person is available as a template variable. user is taken from the global scope<br> if (person.id === user.id) { %&gt;<br>  [“&gt;</pre></p>
<p>  ](#)<br>  [“&gt;</p>
<p>  ](#)<br>&lt;% } %&gt;</p>
<p><code>`</code></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>From there, if you want to use mongodb as your data store, the only thing you need to do is put your configuration in <em>config/connections.js</em> and set that connection in <em>config/model.js</em>. I think it’s a really great framework with powerful features despite the fact it currently lacks contributors (and documentation). </p>
<p>I hope this tutorial gave you a good insight at how Sails works and that you’ll have fun building awesome app with it! Feel free to ask any question on <a href="https://twitter.com/HadrienMilano" target="_blank" rel="noopener">twitter</a> or add a comment below.</p>

            
        </div>
        
    </div>
    
</article>


    <hr />

    <article id="post-archive/sailsjs-tutorial-expenses-tracking-app-part-3" class="article article-type-post" itemscope
    itemprop="blogPost">
    <div class="article-meta">
        
        
    </div>
    <div class="article-inner">
        
        
            <header class="article-header">
                
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-3/">SailsJS tutorial &amp;#124; expenses tracking app (Part 3/4)</a>
    </h1>
  

                <time datetime="2014-12-10T08:50:36.000Z" itemprop="datePublished">December 10, 2014</time>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
            
                <p><a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-2" target="_blank" rel="noopener">Previously</a> in SailsJS tutorial:</p>
<ul>
<li>We created a Sails app and added authentication with passport</li>
<li>We added our styles and less without worrying about compilation and linking</li>
<li>We implemented a basic layout that shows the user’s login status<br>To be fair, the two last parts were actually pretty boring. But now comes the real fun: generating models and APIs. This is something Sails excels at and we’ll really feel like we are building something fast!</li>
</ul>
<h2 id="Generating-models-and-APIs"><a href="#Generating-models-and-APIs" class="headerlink" title="Generating models and APIs"></a>Generating models and APIs</h2><p>When we used <a href="https://www.npmjs.org/package/sails-generate-auth" target="_blank" rel="noopener">sails-generate-auth</a>, we already created a User model. Now the fundamental model for an expenditures tracking app is… guess what ? Expenditures!<br>They have the following attributes: </p>
<ul>
<li>an amount to see how much was spent</li>
<li>a date to sort them chronologically</li>
<li>the person who paid</li>
<li>and a description to remember what it was for<br>Remember: we do not model money exchange, as in “Alice paid XX$ to Bob”. Instead we model individual losses and earnings like this : “Alice spent XX$. Bob earned XX$” (it takes two records instead of one). It looks cumbersome for a group of two but for larger groups it performs better because a user doesn’t need to keep track of his debts for each individual person. Instead there’s just one number to sum everything up.</li>
</ul>
<p>Anyway, let’s get back to our expenditures model. We will generate it using the command line tool<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sails generate api expenditure</span><br></pre></td></tr></table></figure></p>
<p>This generates an empty Expenditure model and an empty ExpenditureController controller under <em>api/</em>.</p>
<p>It may seem quite useless but there’s actually a lot going on already. To demonstrate this, let’s just <em>lift</em> the server. Navigate to localhost:1337/expenditure and you see an empty JSON array. Try browsing to /expenditure/create?amount=39&amp;description=foobar then get back to /expenditure. You just created a model!<br>You can update your model similarly by navigating to /expenditure/update/:id/? where <em>:id</em> is the id of your model and passing similar arguments as for create. You can destroy a model with <em>/expenditure/destroy/:id/</em><br>Play around with it a little to get familiar and come back when you are done.</p>
<p><em>A quick note on security: these routes (/create, /update, /destroy) should <strong>never be used in production</strong>. They can be disabled by setting the property <em>shortcut: false</em> in <em>config/blueprints.js</em>. They are called shortcuts for it allows a developer to easily test his api but it is not meant to be used _by_ the app. The reason is, a crawler could find such url and visit it, thinking it will find a page but instead it will start messing with your data!</em></p>
<p>The right way to use the api is by using the appropriate HTTP terms (GET, POST, PUT, DELETE) like you’d do with <a href="http://backbonejs.org/#Sync" target="_blank" rel="noopener">backbonejs</a>.<br>But, since sails is awesome, they built something special for you. If you go back to your homepage and open the web console, you see that Sails opens a websocket connection automatically. This socket can be used to perform queries. Instead of using classic HTTP queries, you can use io.socket.(get|post|put|delete). It has the same effect but <strong>acts through the socket.io connection!</strong><br>Try the following in your web console. It should create a model then display the list of expenditures and finally destroy the first one it finds:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">io.socket.post(<span class="string">'/expenditure'</span>, &#123;<span class="attr">amount</span>: <span class="number">42</span>, <span class="attr">description</span>: <span class="string">"bought the hitchhiker's guide"</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  io.socket.get(<span class="string">'/expenditure'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">expenditures</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(expenditures);</span><br><span class="line">    io.socket.delete(<span class="string">'/expenditure/'</span>+expenditures[<span class="number">0</span>].id);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>Great, we wrote nothing and have a fully working REST API. It does a lot of things including things we don’t want. The fun thing here is that building an API with Sails consists mostly in having it <em>not do what we don’t want it to do</em> rather than trying to make it do things.</p>
<h2 id="The-API-under-control"><a href="#The-API-under-control" class="headerlink" title="The API under control!"></a>The API under control!</h2><p>Let’s begin by defining model attributes as well as their types. This way we will force our records to conform to some predefined schema.<br>In config/model.js, add the line <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">schema: <span class="literal">true</span></span><br><span class="line"><span class="string">``</span><span class="string">`. This tells sails that it must follow strictly the schemas we are about to define.</span></span><br><span class="line"><span class="string">Now in models/Expenditure.js, insert the following code to define the attributes we talked about earlier:</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line"></span><br><span class="line">  attributes: &#123;</span><br><span class="line">    person    : &#123; </span><br><span class="line">      model: <span class="string">'user'</span>,</span><br><span class="line">      required: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    amount    : &#123; </span><br><span class="line">      type: <span class="string">'integer'</span>, </span><br><span class="line">      required: <span class="literal">true</span> </span><br><span class="line">    &#125;,</span><br><span class="line">    date      : &#123; </span><br><span class="line">      type: <span class="string">'date'</span>, </span><br><span class="line">      required: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    description: &#123; </span><br><span class="line">      type: <span class="string">'string'</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>Also we will want our Users to have a picture attribute. To do this, add a picture attribute of type string. Your User model should look like this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> User = &#123;</span><br><span class="line">  <span class="comment">// Enforce model schema in the case of schemaless databases</span></span><br><span class="line">  schema: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  attributes: &#123;</span><br><span class="line">    username  : &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    picture   : &#123; <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">    passports : &#123; <span class="attr">collection</span>: <span class="string">'Passport'</span>, <span class="attr">via</span>: <span class="string">'user'</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><em>Note that the ‘schema: true’ attribute is optional now that we defined it in the global configuration.</em></p>
<p>Now you can restart the server and if you try to insert nonsense in the database, Sails won’t let you anymore.</p>
<p>Next, we’ll add some policies such that only logged in users can access the expenditures API.</p>
<p>In <em>api/policies/sessionAuth.js</em> replace the <em>req.session.authenticated</em> with <em>req.isAuthenticated()</em>. It should look like this now<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (req.isAuthenticated()) &#123;</span><br><span class="line">    <span class="keyword">return</span> next();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// User is not allowed</span></span><br><span class="line">  <span class="keyword">return</span> res.redirect(<span class="string">'/login'</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>We will also add a custom policy to check when a user owns an expenditure record.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// api/policies/ownsExpenditure.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!req.isAuthenticated()) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.forbidden();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Expenditure.findOne(req.param(<span class="string">'id'</span>)).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, exp</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) next(err);</span><br><span class="line">    <span class="keyword">if</span> (req.user.id === exp.person) &#123;</span><br><span class="line">      <span class="keyword">return</span> next();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res.forbidden();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>To apply these policies, open <em>config/policies.js</em> and define how policies should be applied like this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">ExpenditureController: &#123;</span><br><span class="line">  <span class="string">'*'</span>:      [<span class="string">'passport'</span>, <span class="string">'ownsExpenditure'</span>],</span><br><span class="line">  <span class="string">'find'</span>:   [<span class="string">'passport'</span>, <span class="string">'sessionAuth'</span>],</span><br><span class="line">  <span class="string">'create'</span>: [<span class="string">'passport'</span>, <span class="string">'sessionAuth'</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ... */</span></span><br></pre></td></tr></table></figure></p>
<p>We allow <em>find</em> and <em>create</em> actions to anyone who is authenticated. Every other action can only be performed by someone who owns the target expenditure. Note that ownsExpenditure also checks that the user is authenticated so we don’t need to apply the <em>sessionAuth</em> policy in this case.</p>
<p>All right, now our app is a little more secure. But we are still taking user input as is without doing any verification on it. We need to implement the create action ourselves, this way we can manipulate user input before it is saved to our DB. The following code does exactly what the automagic action was doing for us before but in addition it also cleans the user input before feeding it to the model. Take a few minutes to understand exactly what happens here:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// api/controllers/ExpenditureController.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  create: <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get only the attributes we want and apply defaults</span></span><br><span class="line">    <span class="keyword">var</span> data = &#123;</span><br><span class="line">      description: req.param(<span class="string">'description'</span>),</span><br><span class="line">      amount: req.param(<span class="string">'amount'</span>),</span><br><span class="line">      <span class="comment">// The user is taken directly from the request element. This is what</span></span><br><span class="line">      <span class="comment">// passport gives us and the user cannot easily spoof this information</span></span><br><span class="line">      person: req.user,</span><br><span class="line">      <span class="comment">// Parse the provided date or use current date if none is provided</span></span><br><span class="line">      date: req.param(<span class="string">'date'</span>) != <span class="literal">null</span> ? <span class="keyword">new</span> <span class="built_in">Date</span>(req.param(<span class="string">'date'</span>)) : <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create new instance of model using data from params</span></span><br><span class="line">    Expenditure.create(data).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The data field returned does not contain a fully populated</span></span><br><span class="line">      <span class="comment">// person attribute so we use the one at our disposal (req.user) to continue</span></span><br><span class="line">      <span class="keyword">var</span> expenditure = _.extend(data, &#123;<span class="attr">person</span>: req.user&#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// You can always use this boolean to check if the request was issued on a</span></span><br><span class="line">      <span class="comment">// socket or standard HTTP request</span></span><br><span class="line">      <span class="keyword">if</span> (req.isSocket) &#123;</span><br><span class="line">        <span class="comment">// Subscribe the current socket</span></span><br><span class="line">        Expenditure.subscribe(req, expenditure);</span><br><span class="line">        <span class="comment">// Introduce all class listeners to this instance</span></span><br><span class="line">        Expenditure.introduce(expenditure);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Tell everyone listening that a model was created</span></span><br><span class="line">      Expenditure.publishCreate(expenditure, req);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// (HTTP 201: Created)</span></span><br><span class="line">      res.status(<span class="number">201</span>).send(expenditure.toJSON());</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></p>
<p>Now when a user is logged in and sends a request to create an expenditure, the model gets properly populated with the right ‘person’ attribute. </p>
<p>Your API is now complete! The last thing we are left with is implementing a front-end and we’ll be done. You may have noticed though that we did not override the update method. Therefore someone could still insert stupid data in our database. As an exercise, you can try implementing the update method such that it filters user input before inserting it in the database. You could start from the <a href="https://github.com/balderdashy/sails/blob/master/lib/hooks/blueprints/actions/update.js" target="_blank" rel="noopener">blueprint implementation</a>. It contains many comments and it is a good way to learn more about sails and how it works.</p>
<p><a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-4" target="_blank" rel="noopener"><strong>In the next part</strong></a>, we’ll write a front-end for our sailsjs app.</p>

            
        </div>
        
    </div>
    
</article>


    <hr />

    <article id="post-archive/sailsjs-tutorial-expenses-tracking-app-part-2" class="article article-type-post" itemscope
    itemprop="blogPost">
    <div class="article-meta">
        
        
    </div>
    <div class="article-inner">
        
        
            <header class="article-header">
                
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-2/">SailsJS tutorial &amp;#124; expenses tracking app (Part 2/4)</a>
    </h1>
  

                <time datetime="2014-12-07T14:33:56.000Z" itemprop="datePublished">December 7, 2014</time>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
            
                <p>In the <a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-1/" target="_blank" rel="noopener">previous part</a>, we set up our application and added an authentication mechanism. It is now time to add our custom views and style. We will also use this opportunity to add dynamic content that changes when the user is logged in and an app page that can only be accessed by logged-in users (using policies).</p>
<h2 id="Adding-custom-views"><a href="#Adding-custom-views" class="headerlink" title="Adding custom views"></a>Adding custom views</h2><p>Download <a href="http://hmil.fr/public/sails_tuto_0.zip" target="_blank" rel="noopener">this archive</a> containing the files you’ll need in this part.</p>
<p>Copy the contents of <em>styles</em> in the <em>assets/styles/</em> folder of your project and the <em>views</em> in <em>views/</em>. Replace any file that causes a conflict, we don’t need the defaults anymore ;) .</p>
<p>You may have noticed these comments in <em>view/layout.ejs</em><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!--STYLES--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--STYLES END--&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>When you start sails, it will automatically watch for changes in your assets/ directory and link your stylesheets by adding the appropriate HTML tags there. This is done <em>via</em> grunt, you can have a look at the <em>tasks/</em> folder if you are interested but we won’t detail much how these tasks work in this tutorial.</p>
<p>Now lift your app and refresh your browser. You should see a homepage like the one in the <a href="http://expensiveapp.hmil.fr" target="_blank" rel="noopener">demo</a>. The first thing you’ll notice though is that the title and the description appear as ‘app_name’ and ‘app_desc’. It’s time to introduce you with locales.</p>
<h2 id="Locales"><a href="#Locales" class="headerlink" title="Locales"></a>Locales</h2><p>If you look at <em>homepage.ejs</em>, you will see that the title and descriptions are wrapped in a call to ___()_ . This function will look at your locales and see if it finds a translation for that string in the user’s language. If it cannot find one, it will use the default locale, otherwise it displays the text as is. Locales files are simply JSON files, one per language, that establish a mapping between keys and translated strings. They are located in config/locales. Copy the locales provided in the project archive to this folder. Also since I’ve only included an English and French translation, you can delete the <em>es.json</em> and_ de.json _locales and add this line in <em>config/i18n.json</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">locales: [<span class="string">'en'</span>, <span class="string">'fr'</span>]</span><br></pre></td></tr></table></figure></p>
<p>You’ll need to restart the app for these changes to be effective.</p>
<h2 id="Showing-login-status"><a href="#Showing-login-status" class="headerlink" title="Showing login status"></a>Showing login status</h2><p>Now we’ll want our interface to change when the user is online. One thing we can do is displaying a <em>login</em> action in the navbar when the user is offline and a <em>logout</em> action when online. If you look at <em>layout.ejs</em> line 41 you should see a single login button. Let’s replace this with something more useful:</p>
<p><pre lang="html" line="41"><br>&lt;% if (req.isAuthenticated()) { %&gt;<br>  <li><a href="/logout">Log out</a></li><br>&lt;% } else { %&gt;<br>  <li><a href="/login">Log in</a></li><br>&lt;% } %&gt;</pre></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">As you can see, we have access to the request object _req_ from the view and therefore we can know things about our user. Here we want to know if he is authenticated. Now you may wonder where this _isAuthenticated_ method comes from. We actually need to attach it to the req object. The best place to do this is in passport&apos;s policy since we apply this policy everywhere (remember it just allows us to initialize authentication stuff for the current request, it doesn&apos;t actually perform any kind of check). We add this function before calling _next()_ in _api/policies/passport.js_ so that it looks like this:</span><br><span class="line">```javascript</span><br><span class="line"></span><br><span class="line">module.exports = function (req, res, next) &#123;</span><br><span class="line">  // Initialize Passport</span><br><span class="line">  passport.initialize()(req, res, function () &#123;</span><br><span class="line">    // Use the built-in sessions</span><br><span class="line">    passport.session()(req, res, function () &#123;</span><br><span class="line">      // Make the user available throughout the frontend</span><br><span class="line">      res.locals.user = req.user;</span><br><span class="line"></span><br><span class="line">      req.isAuthenticated = function() &#123;</span><br><span class="line">        return req.user != null;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      next();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Ok now restart your app, navigate to localhost:1337, log-in<br>Aaannnd it doesn’t work again…</p>
<p>Before you start throwing virtual stuff at me, just read why it went wrong:<br>If you look at your routes (<em>/config/routes.js</em>), you’ll see that our homepage view is served directly. This means the view is rendered without the request passing through any controller action. But <strong>policies are only applied to action routes!</strong> So we’ll need to create an action to display the home page since we want our passport policy to apply.<br>Using the command line, be sure to be at the root of your project and run<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sails generate controller main index app</span><br></pre></td></tr></table></figure></p>
<p>This generates a controller called main with two actions index and app. We’ll use index to show the homepage and app to show the actual application page.<br>Open your newly created <em>MainController</em> (under <em>api/controllers/</em>) and replace the index action with the following:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">index: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> res.view(<span class="string">'homepage'</span>);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>Then last thing to do is tell sails to call our controller action when a user reaches ‘/‘. To do this, in <em>config/routes.js</em> remove the value assigned to ‘/‘ and add the following instead:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">'/'</span>: <span class="string">'MainController.index'</span>,</span><br><span class="line"><span class="string">'/app'</span>: <span class="string">'MainController.app'</span>,</span><br></pre></td></tr></table></figure></p>
<p>Note that we are also binding another route that will be useful later.</p>
<p>Now everything should work fine. Try logging-in and out a few times, the navbar updates accordingly.</p>
<p>All right, now we have our custom styles implemented and a basic layout for the app. We can start focusing on the core of the app. In the next part, we will create models and APIs to interact with data relevant to our app and we’ll implement access control to make this a little more secure.</p>
<p><a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-3" target="_blank" rel="noopener"><strong>Read the next part!</strong></a></p>

            
        </div>
        
    </div>
    
</article>


    <hr />

    <article id="post-archive/sailsjs-tutorial-expenses-tracking-app-part-1" class="article article-type-post" itemscope
    itemprop="blogPost">
    <div class="article-meta">
        
        
    </div>
    <div class="article-inner">
        
        
            <header class="article-header">
                
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-1/">SailsJS tutorial &amp;#124; expenses tracking app (part 1/4)</a>
    </h1>
  

                <time datetime="2014-12-05T19:09:03.000Z" itemprop="datePublished">December 5, 2014</time>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
            
                <p>Hello internet,</p>
<p>If you know about SailsJS you also probably know there’s little resources out there to learn this framework. So I though it could be useful to share my personal experience with Sails.<br>This tutorial will cover the following topics:</p>
<ul>
<li><strong>Third-party authentication with passport</strong></li>
<li><strong>The assets pipeline</strong></li>
<li><strong>Interfacing with a realtime JavaScript frontend</strong><br>It should not take you more than an hour to complete and I guess it is particularly well suited for those who, like me, prefer to learn by example.<br>I assume you are already familiar with <a href="http://nodejs.org" title="nodejs" target="_blank" rel="noopener">node</a> and it’s better if you’ve already played a bit with <a href="http://expressjs.com/" title="ExpressJS" target="_blank" rel="noopener">express</a>.</li>
</ul>
<h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2><p>In this tutorial, we will build a small app to streamline expenses management in groups.</p>
<p><strong>You can check out a live demo <a href="http://expensiveapp.hmil.fr" title="tutorial demo application" target="_blank" rel="noopener">here</a></strong><br><em>(hint: open the app in two different windows to see the realtime component in action)</em></p>
<p>Everybody enters how much they paid for the group and how much they got from the group. Each person then gets a report telling how much they have to pay or how much people owe her.<br>Although our version will be pretty stupid I think it is interesting because we will add a realtime twist to it and also we’ll have to interface with third party auth providers so that the user doesn’t have to remember a password just for this app.</p>
<p>All right, let’s get started !</p>
<h2 id="Generating-the-app"><a href="#Generating-the-app" class="headerlink" title="Generating the app"></a>Generating the app</h2><p>Sails comes with a handy command line tool that accelerates repetitive tasks. Install it with<br><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo npm install -g sails</span><br></pre></td></tr></table></figure></p>
<p>That’s it you are now ready to get started !<br>cd to your workspace and run<br><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sails new myApp</span><br></pre></td></tr></table></figure></p>
<p>This will create a sails application with default settings in a “myApp” folder.<br>cd into it and then simply run<br><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd myApp</span><br><span class="line">sails lift</span><br></pre></td></tr></table></figure></p>
<p><a href="/assets/archive/2014/12/sails_lift.png"><img src="/assets/archive/2014/12/sails_lift.png" alt="sails_lift"></a><br>Now navigate to <a href="http://localhost:1337" target="_blank" rel="noopener">localhost:1337</a>. You should see a nice homepage.</p>
<h2 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h2><p>While we are generating our app skeleton let’s deal with the authentication right now so we won’t have to worry about it later.<br>We will use a generator for that purpose. One good thing about sails is that you can do many things without writing explicit code, and when you have to do so, there’s a generator that writes it for you !<br><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo npm install -g sails-generate-auth</span><br></pre></td></tr></table></figure></p>
<p>Now at the root of your app, generate auth stuff with<br><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sails generate auth</span><br></pre></td></tr></table></figure></p>
<p>This generated a bunch of files, including a controller to handle login, logout and registration, a User model and a template config file. Now there’s still some configuration work to do.</p>
<p>First, in config/passport.js, you can see some of the supported auth strategies. For this demo we’ll use a third party provider. Pick your favorite one, comment out the other ones (including <em>local</em>) create an app on their website and come back with your app ID and SECRET. You’ll also need to add a “profileFields” property to tell passport what information you want it to fetch on registration.<br>I used <a href="https://developers.facebook.com/apps" target="_blank" rel="noopener">facebook</a> and it gives me something like this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports.passport = &#123;</span><br><span class="line">  facebook: &#123;</span><br><span class="line">    name: <span class="string">'Facebook'</span>,</span><br><span class="line">    protocol: <span class="string">'oauth2'</span>,</span><br><span class="line">    strategy: <span class="built_in">require</span>(<span class="string">'passport-facebook'</span>).Strategy,</span><br><span class="line">    options: &#123;</span><br><span class="line">      <span class="comment">// Don't forget to add this line </span></span><br><span class="line">      profileFields: [<span class="string">'id'</span>, <span class="string">'displayName'</span>, <span class="string">'photos'</span>, <span class="string">'username'</span>, <span class="string">'email'</span>],</span><br><span class="line">      clientID: <span class="string">'MY_APP_ID'</span>,</span><br><span class="line">      clientSecret: <span class="string">'MY_APP_SECRET'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>Next thing you’ll have to do is open config/routes.js and add these routes:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// There should already be this:</span></span><br><span class="line"><span class="string">'/'</span>: &#123;</span><br><span class="line">  view: <span class="string">'homepage'</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// So you just need to add that:</span></span><br><span class="line"><span class="string">'get /login'</span>: <span class="string">'AuthController.login'</span>,</span><br><span class="line"><span class="string">'get /logout'</span>: <span class="string">'AuthController.logout'</span>,</span><br><span class="line"><span class="string">'get /register'</span>: <span class="string">'AuthController.register'</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">'post /auth/local'</span>: <span class="string">'AuthController.callback'</span>,</span><br><span class="line"><span class="string">'post /auth/local/:action'</span>: <span class="string">'AuthController.callback'</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">'get /auth/:provider'</span>: <span class="string">'AuthController.provider'</span>,</span><br><span class="line"><span class="string">'get /auth/:provider/callback'</span>: <span class="string">'AuthController.callback'</span>,</span><br><span class="line"><span class="string">'get /auth/:provider/:action'</span>: <span class="string">'AuthController.callback'</span>,</span><br></pre></td></tr></table></figure></p>
<p>This wires up the AuthController you generated two minutes ago to sail’s HTTP router by binding HTTP routes to the appropriate controller actions.</p>
<p>All right you’re almost there, we’ll now open config/bootstrap.js and change the contents with this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports.bootstrap = <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">  sails.services.passport.loadStrategies();</span><br><span class="line">  cb();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>This function is called when you <em>lift</em> your app allowing you to perform initial loading. Here we tell passport to load the strategies we specified in config/passport.js.</p>
<p>You now have a working authentication mechanism integrated in your app ! The last thing to do is to add the passport policy to all routes. This tells sails that every incoming request should go through passport’s middleware before reaching any controller. The middleware will transparently take care of associating sessions with users so that you can user req.user to know who you are dealing with in your controller and views.<br>To do so, add the following line in config/policies.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'*'</span>: [ <span class="string">'passport'</span> ]</span><br></pre></td></tr></table></figure></p>
<p>All right, you’re done, now let’s lift the app again…<br>Aaaand it fails.</p>
<p>What happened is that the generator generates the code for you but doesn’t install the required modules. You’ll need the following modules:<br><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save passport passport-facebook validator bcryptjs</span><br></pre></td></tr></table></figure></p>
<p>OK now you can <em>lift</em> and it should work. You will be asked the data migration mode, choose any option it doesn’t matter. You can turn this off by uncommenting the line <em>migrate: ‘alter’</em> in <em>config/models.js</em></p>
<p>Navigate to <a href="http://localhost:1337/login" target="_blank" rel="noopener">/login</a>, log in the app and you should be redirected to the homepage. You cannot see your login status yet but don’t worry this will come in the next part.</p>
<p>If you are still with me at this point, congratulations ! You just did the hard part. With this in place, we can start doing fun stuff and see how Sails really saves us huge amounts of time.</p>
<p>In the next part, we will remove this ugly homepage and add our own views, we will also add assets and see how sails assets pipeline makes your life easier.</p>
<p><strong><a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-2/" target="_blank" rel="noopener">Go to part 2!</a></strong></p>

            
        </div>
        
    </div>
    
</article>


    <hr />


<a href="/archives">View all posts</a>
  </div>
  <footer id="footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2021 Hadrien Milano<br>
    </div>
  </div>
</footer>
</body>
</html>