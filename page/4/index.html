<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="XEkaOnI5YgD6GPlLusy7Z7U91v35YU9Q0eX1KslsVoQ" />
  

  
  <title>hmil&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="hmil&#39;s blog">
<meta property="og:url" content="https://hmil.github.io/page/4/index.html">
<meta property="og:site_name" content="hmil&#39;s blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hmil&#39;s blog">
  
    <link rel="alternate" href="/atom.xml" title="hmil&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">hmil&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">random tech write-ups</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://hmil.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-archive/sailsjs-tutorial-expenses-tracking-app-part-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-2/" class="article-date">
  <time datetime="2014-12-07T14:33:56.000Z" itemprop="datePublished">2014-12-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/archived/">archived</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-2/">SailsJS tutorial &amp;#124; expenses tracking app (Part 2/4)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In the <a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-1/" target="_blank" rel="noopener">previous part</a>, we set up our application and added an authentication mechanism. It is now time to add our custom views and style. We will also use this opportunity to add dynamic content that changes when the user is logged in and an app page that can only be accessed by logged-in users (using policies).</p>
<h2 id="Adding-custom-views"><a href="#Adding-custom-views" class="headerlink" title="Adding custom views"></a>Adding custom views</h2><p>Download <a href="http://hmil.fr/public/sails_tuto_0.zip" target="_blank" rel="noopener">this archive</a> containing the files you’ll need in this part.</p>
<p>Copy the contents of <em>styles</em> in the <em>assets/styles/</em> folder of your project and the <em>views</em> in <em>views/</em>. Replace any file that causes a conflict, we don’t need the defaults anymore ;) .</p>
<p>You may have noticed these comments in <em>view/layout.ejs</em><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!--STYLES--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--STYLES END--&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>When you start sails, it will automatically watch for changes in your assets/ directory and link your stylesheets by adding the appropriate HTML tags there. This is done <em>via</em> grunt, you can have a look at the <em>tasks/</em> folder if you are interested but we won’t detail much how these tasks work in this tutorial.</p>
<p>Now lift your app and refresh your browser. You should see a homepage like the one in the <a href="http://expensiveapp.hmil.fr" target="_blank" rel="noopener">demo</a>. The first thing you’ll notice though is that the title and the description appear as ‘app_name’ and ‘app_desc’. It’s time to introduce you with locales.</p>
<h2 id="Locales"><a href="#Locales" class="headerlink" title="Locales"></a>Locales</h2><p>If you look at <em>homepage.ejs</em>, you will see that the title and descriptions are wrapped in a call to ___()_ . This function will look at your locales and see if it finds a translation for that string in the user’s language. If it cannot find one, it will use the default locale, otherwise it displays the text as is. Locales files are simply JSON files, one per language, that establish a mapping between keys and translated strings. They are located in config/locales. Copy the locales provided in the project archive to this folder. Also since I’ve only included an English and French translation, you can delete the <em>es.json</em> and_ de.json _locales and add this line in <em>config/i18n.json</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">locales: [<span class="string">'en'</span>, <span class="string">'fr'</span>]</span><br></pre></td></tr></table></figure></p>
<p>You’ll need to restart the app for these changes to be effective.</p>
<h2 id="Showing-login-status"><a href="#Showing-login-status" class="headerlink" title="Showing login status"></a>Showing login status</h2><p>Now we’ll want our interface to change when the user is online. One thing we can do is displaying a <em>login</em> action in the navbar when the user is offline and a <em>logout</em> action when online. If you look at <em>layout.ejs</em> line 41 you should see a single login button. Let’s replace this with something more useful:</p>
<p><pre lang="html" line="41"><br>&lt;% if (req.isAuthenticated()) { %&gt;<br>  <li><a href="/logout">Log out</a></li><br>&lt;% } else { %&gt;<br>  <li><a href="/login">Log in</a></li><br>&lt;% } %&gt;</pre></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">As you can see, we have access to the request object _req_ from the view and therefore we can know things about our user. Here we want to know if he is authenticated. Now you may wonder where this _isAuthenticated_ method comes from. We actually need to attach it to the req object. The best place to do this is in passport&apos;s policy since we apply this policy everywhere (remember it just allows us to initialize authentication stuff for the current request, it doesn&apos;t actually perform any kind of check). We add this function before calling _next()_ in _api/policies/passport.js_ so that it looks like this:</span><br><span class="line">```javascript</span><br><span class="line"></span><br><span class="line">module.exports = function (req, res, next) &#123;</span><br><span class="line">  // Initialize Passport</span><br><span class="line">  passport.initialize()(req, res, function () &#123;</span><br><span class="line">    // Use the built-in sessions</span><br><span class="line">    passport.session()(req, res, function () &#123;</span><br><span class="line">      // Make the user available throughout the frontend</span><br><span class="line">      res.locals.user = req.user;</span><br><span class="line"></span><br><span class="line">      req.isAuthenticated = function() &#123;</span><br><span class="line">        return req.user != null;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      next();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Ok now restart your app, navigate to localhost:1337, log-in<br>Aaannnd it doesn’t work again…</p>
<p>Before you start throwing virtual stuff at me, just read why it went wrong:<br>If you look at your routes (<em>/config/routes.js</em>), you’ll see that our homepage view is served directly. This means the view is rendered without the request passing through any controller action. But <strong>policies are only applied to action routes!</strong> So we’ll need to create an action to display the home page since we want our passport policy to apply.<br>Using the command line, be sure to be at the root of your project and run<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sails generate controller main index app</span><br></pre></td></tr></table></figure></p>
<p>This generates a controller called main with two actions index and app. We’ll use index to show the homepage and app to show the actual application page.<br>Open your newly created <em>MainController</em> (under <em>api/controllers/</em>) and replace the index action with the following:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">index: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> res.view(<span class="string">'homepage'</span>);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>Then last thing to do is tell sails to call our controller action when a user reaches ‘/‘. To do this, in <em>config/routes.js</em> remove the value assigned to ‘/‘ and add the following instead:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">'/'</span>: <span class="string">'MainController.index'</span>,</span><br><span class="line"><span class="string">'/app'</span>: <span class="string">'MainController.app'</span>,</span><br></pre></td></tr></table></figure></p>
<p>Note that we are also binding another route that will be useful later.</p>
<p>Now everything should work fine. Try logging-in and out a few times, the navbar updates accordingly.</p>
<p>All right, now we have our custom styles implemented and a basic layout for the app. We can start focusing on the core of the app. In the next part, we will create models and APIs to interact with data relevant to our app and we’ll implement access control to make this a little more secure.</p>
<p><a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-3" target="_blank" rel="noopener"><strong>Read the next part!</strong></a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hmil.github.io/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-2/" data-id="cjh6d84dg001wl3yhg8srtnuw" class="article-share-link">Share</a>
      
        <a href="https://hmil.github.io/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-archive/sailsjs-tutorial-expenses-tracking-app-part-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-1/" class="article-date">
  <time datetime="2014-12-05T19:09:03.000Z" itemprop="datePublished">2014-12-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/archived/">archived</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-1/">SailsJS tutorial &amp;#124; expenses tracking app (part 1/4)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Hello internet,</p>
<p>If you know about SailsJS you also probably know there’s little resources out there to learn this framework. So I though it could be useful to share my personal experience with Sails.<br>This tutorial will cover the following topics:</p>
<ul>
<li><strong>Third-party authentication with passport</strong></li>
<li><strong>The assets pipeline</strong></li>
<li><strong>Interfacing with a realtime JavaScript frontend</strong><br>It should not take you more than an hour to complete and I guess it is particularly well suited for those who, like me, prefer to learn by example.<br>I assume you are already familiar with <a href="http://nodejs.org" title="nodejs" target="_blank" rel="noopener">node</a> and it’s better if you’ve already played a bit with <a href="http://expressjs.com/" title="ExpressJS" target="_blank" rel="noopener">express</a>.</li>
</ul>
<h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2><p>In this tutorial, we will build a small app to streamline expenses management in groups.</p>
<p><strong>You can check out a live demo <a href="http://expensiveapp.hmil.fr" title="tutorial demo application" target="_blank" rel="noopener">here</a></strong><br><em>(hint: open the app in two different windows to see the realtime component in action)</em></p>
<p>Everybody enters how much they paid for the group and how much they got from the group. Each person then gets a report telling how much they have to pay or how much people owe her.<br>Although our version will be pretty stupid I think it is interesting because we will add a realtime twist to it and also we’ll have to interface with third party auth providers so that the user doesn’t have to remember a password just for this app.</p>
<p>All right, let’s get started !</p>
<h2 id="Generating-the-app"><a href="#Generating-the-app" class="headerlink" title="Generating the app"></a>Generating the app</h2><p>Sails comes with a handy command line tool that accelerates repetitive tasks. Install it with<br><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo npm install -g sails</span><br></pre></td></tr></table></figure></p>
<p>That’s it you are now ready to get started !<br>cd to your workspace and run<br><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sails new myApp</span><br></pre></td></tr></table></figure></p>
<p>This will create a sails application with default settings in a “myApp” folder.<br>cd into it and then simply run<br><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd myApp</span><br><span class="line">sails lift</span><br></pre></td></tr></table></figure></p>
<p><a href="/assets/archive/2014/12/sails_lift.png"><img src="/assets/archive/2014/12/sails_lift.png" alt="sails_lift"></a><br>Now navigate to <a href="http://localhost:1337" target="_blank" rel="noopener">localhost:1337</a>. You should see a nice homepage.</p>
<h2 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h2><p>While we are generating our app skeleton let’s deal with the authentication right now so we won’t have to worry about it later.<br>We will use a generator for that purpose. One good thing about sails is that you can do many things without writing explicit code, and when you have to do so, there’s a generator that writes it for you !<br><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo npm install -g sails-generate-auth</span><br></pre></td></tr></table></figure></p>
<p>Now at the root of your app, generate auth stuff with<br><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sails generate auth</span><br></pre></td></tr></table></figure></p>
<p>This generated a bunch of files, including a controller to handle login, logout and registration, a User model and a template config file. Now there’s still some configuration work to do.</p>
<p>First, in config/passport.js, you can see some of the supported auth strategies. For this demo we’ll use a third party provider. Pick your favorite one, comment out the other ones (including <em>local</em>) create an app on their website and come back with your app ID and SECRET. You’ll also need to add a “profileFields” property to tell passport what information you want it to fetch on registration.<br>I used <a href="https://developers.facebook.com/apps" target="_blank" rel="noopener">facebook</a> and it gives me something like this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports.passport = &#123;</span><br><span class="line">  facebook: &#123;</span><br><span class="line">    name: <span class="string">'Facebook'</span>,</span><br><span class="line">    protocol: <span class="string">'oauth2'</span>,</span><br><span class="line">    strategy: <span class="built_in">require</span>(<span class="string">'passport-facebook'</span>).Strategy,</span><br><span class="line">    options: &#123;</span><br><span class="line">      <span class="comment">// Don't forget to add this line </span></span><br><span class="line">      profileFields: [<span class="string">'id'</span>, <span class="string">'displayName'</span>, <span class="string">'photos'</span>, <span class="string">'username'</span>, <span class="string">'email'</span>],</span><br><span class="line">      clientID: <span class="string">'MY_APP_ID'</span>,</span><br><span class="line">      clientSecret: <span class="string">'MY_APP_SECRET'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>Next thing you’ll have to do is open config/routes.js and add these routes:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// There should already be this:</span></span><br><span class="line"><span class="string">'/'</span>: &#123;</span><br><span class="line">  view: <span class="string">'homepage'</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// So you just need to add that:</span></span><br><span class="line"><span class="string">'get /login'</span>: <span class="string">'AuthController.login'</span>,</span><br><span class="line"><span class="string">'get /logout'</span>: <span class="string">'AuthController.logout'</span>,</span><br><span class="line"><span class="string">'get /register'</span>: <span class="string">'AuthController.register'</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">'post /auth/local'</span>: <span class="string">'AuthController.callback'</span>,</span><br><span class="line"><span class="string">'post /auth/local/:action'</span>: <span class="string">'AuthController.callback'</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">'get /auth/:provider'</span>: <span class="string">'AuthController.provider'</span>,</span><br><span class="line"><span class="string">'get /auth/:provider/callback'</span>: <span class="string">'AuthController.callback'</span>,</span><br><span class="line"><span class="string">'get /auth/:provider/:action'</span>: <span class="string">'AuthController.callback'</span>,</span><br></pre></td></tr></table></figure></p>
<p>This wires up the AuthController you generated two minutes ago to sail’s HTTP router by binding HTTP routes to the appropriate controller actions.</p>
<p>All right you’re almost there, we’ll now open config/bootstrap.js and change the contents with this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports.bootstrap = <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">  sails.services.passport.loadStrategies();</span><br><span class="line">  cb();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>This function is called when you <em>lift</em> your app allowing you to perform initial loading. Here we tell passport to load the strategies we specified in config/passport.js.</p>
<p>You now have a working authentication mechanism integrated in your app ! The last thing to do is to add the passport policy to all routes. This tells sails that every incoming request should go through passport’s middleware before reaching any controller. The middleware will transparently take care of associating sessions with users so that you can user req.user to know who you are dealing with in your controller and views.<br>To do so, add the following line in config/policies.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'*'</span>: [ <span class="string">'passport'</span> ]</span><br></pre></td></tr></table></figure></p>
<p>All right, you’re done, now let’s lift the app again…<br>Aaaand it fails.</p>
<p>What happened is that the generator generates the code for you but doesn’t install the required modules. You’ll need the following modules:<br><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save passport passport-facebook validator bcryptjs</span><br></pre></td></tr></table></figure></p>
<p>OK now you can <em>lift</em> and it should work. You will be asked the data migration mode, choose any option it doesn’t matter. You can turn this off by uncommenting the line <em>migrate: ‘alter’</em> in <em>config/models.js</em></p>
<p>Navigate to <a href="http://localhost:1337/login" target="_blank" rel="noopener">/login</a>, log in the app and you should be redirected to the homepage. You cannot see your login status yet but don’t worry this will come in the next part.</p>
<p>If you are still with me at this point, congratulations ! You just did the hard part. With this in place, we can start doing fun stuff and see how Sails really saves us huge amounts of time.</p>
<p>In the next part, we will remove this ugly homepage and add our own views, we will also add assets and see how sails assets pipeline makes your life easier.</p>
<p><strong><a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-2/" target="_blank" rel="noopener">Go to part 2!</a></strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hmil.github.io/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-1/" data-id="cjh6d84de001rl3yhil0rdezi" class="article-share-link">Share</a>
      
        <a href="https://hmil.github.io/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-1/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-archive/cagificator-behind-the-scenes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/11/archive/cagificator-behind-the-scenes/" class="article-date">
  <time datetime="2014-11-19T17:33:58.000Z" itemprop="datePublished">2014-11-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/random/">random</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/archive/cagificator-behind-the-scenes/">Cagificator: behind the scenes</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>After a few successful cagifications of my friend’s profile pictures I felt the need for an automated tool to save me some time. So I quickly hacked <a href="http://cage.hmil.fr" title="The cagificator" target="_blank" rel="noopener">a cagifier app</a> for that purpose. In this article I will explain a little bit of what’s behind this app and how it could be improved.</p>
<p>To get started, I analyzed how a manual cagification is done and how it could be automated. When you manually cage someone, you usually follow these steps:<br>1. Find a good candidate face replacement</p>
<ol start="2">
<li>Align it with the original face’s features (eyes, mouth, …)<br>3. Adjust the hue/saturation/value<br>4. fade out the edges to get a smooth transition<br><del>5. upload the image as the victim’s facebook profile picture</del></li>
</ol>
<p>We quickly see what the main challenges are. First one must identify faces in the picture and extract features positions. Second, a powerful color correction algorithm must be applied. And finally we must be able to choose a suitable candidate from a replacement picture database.</p>
<p>To make things easier, I decided to manually create a collection of replacements masks. These masks are face pictures with smooth edges and cut just the right way to avoid showing face borders (hair, chin, ears, …). Now on to the serious stuff:</p>
<h2 id="Face-detection"><a href="#Face-detection" class="headerlink" title="Face detection"></a>Face detection</h2><p><a href="/assets/archive/2014/11/landmarks.jpg"><img src="/assets/archive/2014/11/landmarks.jpg" alt="landmarks"></a><br>There’s this awesome tool called <a href="http://cmp.felk.cvut.cz/~uricamic/flandmark/" title="flandmarks" target="_blank" rel="noopener">flandmarks</a> which allows you to extract facial landmarks from an image. But first you need to get a bounding box for the face. For that I chose to use OpenCV’s haar cascades. There’s a good tutorial on that <a href="http://docs.opencv.org/trunk/doc/py_tutorials/py_objdetect/py_face_detection/py_face_detection.html" target="_blank" rel="noopener">here</a>. Then let flandmarks do its magic and you’ve got the data you need. Flandmarks comes with an example showing how to do that with OpenCV.</p>
<p>This needs to be computed once for all replacement pictures and then once for every picture submited. To align the faces I just compute a transformation matrix that has one translation, one scaling and a rotation such that the leftmost and rightmost points (edge of the eyes) are aligned and the face “height” (y offset between the eyes and the mouth) is the same. This is basic linear algebra that won’t be discussed here.</p>
<h2 id="Color-correction"><a href="#Color-correction" class="headerlink" title="Color correction"></a>Color correction</h2><p>The color correction tries to mimic the way I would do it by hand.<br>First I compute an HSV histogram for the target and replacement face. To get the target’s histogram I use the alpha mask of the candidate such that both histograms are computed on the same set of pixels.</p>
<p>The hue is the easiest part : I compute the mean HUE and then I shift the HUE of every pixel in the replacement picture by the offset between both mean values.<br>For Value and Saturation, it gets a little more tricky. I first tried to multiply V and S of every pixel by some coefficient such that the mean Saturation of the replacement matches the mean Saturation of the target. But this tends to attenuate contrast and the difference in contrast is highly visible.<br>So i tried another way, hopefully a more successful one. If i want to keep the same contrast as the original level, I would actually need to identify the “range” in which most of the histogram bars are and stretch the replacement image histogram to fit the target’s one.<br>The easiest way to do that is compute a linear function y = ax + b that’s applied to the target’s pixels. With a well chosen function we can have the target and replacement histograms overlap as shown in the following picture.</p>
<p>[caption id=”attachment_44” align=”alignnone” width=”1195”]<a href="/assets/archive/2014/11/histograms.png"><img src="/assets/archive/2014/11/histograms.png" alt="histograms"></a> From left to right: masked target image, replacement image, color-corrected replacement ; Hue (H), Saturation (S) and Value (V) plots.<br> The plot shows: the target image histograms (red) and the corrected replacement (green). We can see that the replacement’s V histogram has been stretched so that it occupies all of the available space (replacement has less contrast than target) and that its S plot was compressed near zero (conversion to black and white).<br> Hue is pointless since this is B&amp;W. The horizontal red line is the threshold.[/caption]</p>
<p>To determine the coefficients a and b, we pick an arbitrary threshold. All bars lower than this threshold in the histogram are ignored. We can then get the minimum and maximum values for which there is something in the histogram. We do this for both the target and the replacement and then it’s high school math to find a and b.This work is done independently for the S and V channels as they are independent variables.</p>
<p>In the end, the following correction is applied to each pixel :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dstS = srcS * aS + bS</span><br><span class="line">dstV = srcV * aV + bV</span><br><span class="line">// Hue is cyclic so instead of capping max and min values, use a modulo</span><br><span class="line">dstH = srcH + (targetMeanH - replacementMeanH) % 255</span><br></pre></td></tr></table></figure></p>
<h2 id="Candidate-picking"><a href="#Candidate-picking" class="headerlink" title="Candidate picking"></a>Candidate picking</h2><p>The last big feature to implement is choosing the right replacement image. Now I was a bit tired of this project when reaching this point so I definitely chose the lazy option. That is, to compute the transformations mentioned above for each picture, then compute the sum of the absolute color difference for each pixel of the image. The replacement that has the lowest sum is the best.</p>
<p>This is definitely not optimal since it favors overall low absolute difference but does not deal with face alignments. One could hope that if for instance the mouth is not well aligned, it will yield a higher score and the candidate will be rejected. However it is not the case and many results suffer from alignment problems. Also this solution is computationally intensive and you can see it starts lagging seriously when your image contains multiple faces.</p>
<p>&nbsp;</p>
<p>Overall it’s been a fun experiment and although this is far from perfect, I’m amazed to see that for some particular images I wouldn’t have done better myself.<br>Be sure to <a href="http://cage.hmil.fr" target="_blank" rel="noopener">try it out</a> and if you obtain nice results, feel free to link the picture in the comments !</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hmil.github.io/2014/11/archive/cagificator-behind-the-scenes/" data-id="cjh6d84dc001ol3yha1qq8b0o" class="article-share-link">Share</a>
      
        <a href="https://hmil.github.io/2014/11/archive/cagificator-behind-the-scenes/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/archived/">archived</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hacking/">hacking</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/random/">random</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/software-engineering/">software engineering</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/GitHub/" style="font-size: 10px;">GitHub</a> <a href="/tags/TypeScript/" style="font-size: 20px;">TypeScript</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/architecture/" style="font-size: 15px;">architecture</a> <a href="/tags/funrun/" style="font-size: 10px;">funrun</a> <a href="/tags/funrun2/" style="font-size: 10px;">funrun2</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/hack/" style="font-size: 10px;">hack</a> <a href="/tags/monorepo/" style="font-size: 15px;">monorepo</a> <a href="/tags/reverse-engineering/" style="font-size: 10px;">reverse engineering</a> <a href="/tags/satire/" style="font-size: 10px;">satire</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/05/How-not-to-suck-at-github/">How not to suck at GitHub</a>
          </li>
        
          <li>
            <a href="/2018/05/TypeScript-project-structure2/">How to manage and publish a multi-package TypeScript project</a>
          </li>
        
          <li>
            <a href="/2018/03/TypeScript-project-structure/">Tips and tricks to structure multi-package TypeScript projects</a>
          </li>
        
          <li>
            <a href="/2017/08/archive/deal-with-nullables-like-theyre-not-even-here-good-coding-practices-in-typescript/">Deal with nullables like they&#39;re not even here - Good coding practices in TypeScript.</a>
          </li>
        
          <li>
            <a href="/2016/10/archive/you-should-worry-about-vary/">You should worry about Vary</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Hadrien Milano<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'hmil';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>