<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="XEkaOnI5YgD6GPlLusy7Z7U91v35YU9Q0eX1KslsVoQ" />
  

  
  <title>hmil&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="hmil&#39;s blog">
<meta property="og:url" content="https://hmil.github.io/page/3/index.html">
<meta property="og:site_name" content="hmil&#39;s blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hmil&#39;s blog">
  
    <link rel="alternate" href="/atom.xml" title="hmil&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">hmil&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">random tech write-ups</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://hmil.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-00-hacking-funrun2-how-to-reverse-engineer-a-corona-app" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/02/00-hacking-funrun2-how-to-reverse-engineer-a-corona-app/" class="article-date">
  <time datetime="2015-02-13T16:27:12.000Z" itemprop="datePublished">2015-02-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/hacking/">hacking</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/00-hacking-funrun2-how-to-reverse-engineer-a-corona-app/">Hacking FunRun2 — how to reverse engineer a Corona app</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>Disclaimer:</strong> This article is a bit old and does not apply to recent versions of the corona sdk. It is put here <strong>for educational purpose</strong>, showing how one may try to break into this kind of applications. <strong>It is not a magic formula for hacking all corona apps across all versions of the sdk.</strong></p>
<p><a href="/assets/archive/2015/02/2015-02-13-17-38-04.jpg"><img src="/assets/archive/2015/02/2015-02-13-17-38-04.jpg" alt="funrun2 hack"></a></p>
<p>If you haven’t played funrun yet, you probably will soon. Funrun2 is one of the best multiplayer mobile games out there. It’s one of these rare games where you can have all the fun from the very first game you play, but still stays enjoyable after month of playing it. It’s my favorite game on mobile and since I had some spare time, I decided to tear it open (yeah, that’s what I do to things I like). It was a bit harder than expected and involves some not so trivial hacking as well as a bit of luck. By the way, yes, all these buttons work.</p>
<h2 id="The-easy-part"><a href="#The-easy-part" class="headerlink" title="The easy part"></a>The easy part</h2><p>First I need to get my hands on the <em>.apk</em> file. There’s plenty of tools out there to do that, some of them are even <a href="https://github.com/Lekensteyn/apk-downloader" target="_blank" rel="noopener">open source</a>.</p>
<p>An apk file is an archive, just like a jar or a zip so I can unpack it with regular unzipping tools. This gives me access to a <a href="http://en.wikipedia.org/wiki/Android_application_package" target="_blank" rel="noopener">well documented</a> directory structure. The two things I want are the <em>classes.dex</em> file, containing java bytecode, and the assets directory. Reversing the first one allows me to get access to java source code so it’s pretty obvious why I want to look at it.<br>To understand why the second one is interesting though, you must consider that this game was built with a cross platform framework, namely corona. These kind of framework generally allow you to code your app with some scripting language that gets executed on every platform the same way. Therefore, unless the script is cross compiled to native language (which nobody ever does), it must be stored somewhere. That’s when the assets folder comes to play. It contains only a few images and this <em>resource.car</em> file which extension conveniently matches Corona <em>ARchive</em>. How cool is that ?<br>I open the file in a text editor and mostly get binary-unreadable-shit but there’s also strings like “lua.whatever.that.is.lu”. There are the scripts.<br><em>In case you don’t know: <a href="http://www.lua.org/" target="_blank" rel="noopener">lua</a> is one of the main scripting languages used in games with it’s open-source libraries and tools.</em></p>
<p>Now I still haven’t figured out where the images and sounds are (the corona archive weights a mere 2MB so it doesn’t contain any asset), but this will come later.</p>
<h2 id="Things-getting-interesting"><a href="#Things-getting-interesting" class="headerlink" title="Things getting interesting"></a>Things getting interesting</h2><p>Trying to open the corona archive, I quickly realize it’s not a common archive format (even 7-zip can’t open it !). So there are two ways to go: finding the loading procedure in the java code or analyzing the file structure by hand. The first seems more reasonable.<br>But first, let’s decompile the dalvik bytecode into human readable java. These tools are helpful: <a href="https://code.google.com/p/dex2jar/" target="_blank" rel="noopener">dex2jar</a> to covert the <em>.dex</em> to <em>.class</em> (<a href="http://en.wikipedia.org/wiki/Dalvik_%28software%29" target="_blank" rel="noopener">dalvik</a> to <a href="http://en.wikipedia.org/wiki/Java_virtual_machine" target="_blank" rel="noopener">jvm</a>) and <a href="http://jd.benow.ca/" target="_blank" rel="noopener">jd</a> to go back to plain java source code.</p>
<p>Now I have a load of java source code to look into, great! Let’s look for the string “resource.car”: no results. Looking manually, I quickly find corona’s source code in com/ansca/corona, that’s where the magic must happen. However, nothing is nearly dealing with a “resource” nor a “.car” file. I find however references to images. They were actually located on the device’s external storage (sdcard/Android/obb) in a <em>.obb</em> file. This is something common on android devices (that I wasn’t aware of before doing this hack), my guess is that moving resources allows the apk to be lighter and makes the internal memory footprint smaller. A <em>.obb</em> file is just a zip with a fancy extension. I can grab this file on a computer, edit the images/sounds/whatever and put it back in place. The game still runs with my custom images.</p>
<p>[caption id=”attachment_177” align=”aligncenter” width=”700”]<a href="/assets/archive/2015/02/2015-02-13-17-54-08.jpg"><img src="/assets/archive/2015/02/2015-02-13-17-54-08.jpg" alt="funrun_image"></a> Besides adding childish drawings to the game, there’s not much that can be done this way.[/caption]</p>
<p>I’m in a dead-end with the java code. Let’s give a shot at manually reversing the resource.car file:</p>
<p>I open it with a hex editor and quickly realize the format used is trivial:</p>
<p>First, a header <del>to rule them all</del>, then comes an index made of each file name + position (address) of it’s contents in the archive, then comes the data block with each file contents.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[header] 16 bytes</span><br><span class="line"></span><br><span class="line">[index]</span><br><span class="line">  [entry]</span><br><span class="line">   [header] (4 bytes) 1</span><br><span class="line">   [block addr] (4 bytes)</span><br><span class="line">   [nameS] (4 bytes)</span><br><span class="line">   [name] (nameS+1 bytes) 0-terminated</span><br><span class="line">   [padding] (0s to complete 4x addr)</span><br><span class="line"></span><br><span class="line">[files]</span><br><span class="line">  [entry]</span><br><span class="line">    [header] (4 bytes) 2</span><br><span class="line">    [??] (4 bytes)</span><br><span class="line">    [size] (4 bytes)</span><br><span class="line">    [file] (no 0 termination)</span><br><span class="line">    [padding] (to next 4x addr)</span><br></pre></td></tr></table></figure></p>
<p><em>The resource.car file format</em></p>
<p>Now I didn’t have to code a packer for this format myself because luckily, someone already did that. So I grabbed this <em>corona archive packer/unpacker</em> which you won’t find a link to on my blog.</p>
<p>It turns out the archive contains uncompressed precompiled lua scripts, using luadec and then luac again you can decompile and then recompile these scripts which is very convenient. These lua scripts define absolutely every aspect of the game. From where a button might be to how fast a player can move and what a specific powerup does.<br>Injecting our custom resource.car in the app is a big deal because I could modify anything in the game.</p>
<p>First I try modifying something inside the precompiled lua scripts, such as a string since we can easily recognize them. If this works, I can later try to recompile one file from the (modified) source.<br>I repack the resource and put it back in the apk file, sign it with dex2jar (as explained <a href="https://code.google.com/p/dex2jar/wiki/ModifyApkWithDexTool" target="_blank" rel="noopener">here</a>) and install it on my device. I launch the game and, with no real surprise, it crashes.</p>
<p>I figured there’s probably some kind of check performed against the archive to guarantee integrity. However, the loader is nowhere to be found in the java source. This battle is lost but not the war.</p>
<h2 id="Going-down"><a href="#Going-down" class="headerlink" title="Going down"></a>Going down</h2><p><a href="/assets/archive/2015/02/a88.jpg"><img src="/assets/archive/2015/02/a88.jpg" alt="a88"></a></p>
<p>Yeah, maybe Di Caprio is right, we need to go low-level and find this resource loading procedure.<br>Inside the .apk, there’s another directory called “lib”. It contains architecture-specific libraries. You’d usually build a native library either when you have no choice but use C (for instance, lua is written in C) or when you want higher-than-java performances (for a game framework, it makes sense).</p>
<p>In this lib folder, there’s some lua libraries, but also random libs for sound, video, analytics and whatever. Most importantly I find here a lib called <em>libcorona.so</em>. Let’s quickly open it with a text editor to search for the string “resource.car”, bingo!</p>
<p>I’ll have to disassemble the lib in order to understand what’s happening in there. It turns out, there’s an amazing tool that does this and it’s called <a href="https://www.hex-rays.com/products/ida" target="_blank" rel="noopener">IDA</a>. It’s more than a cross-architecture disassembler, it does lot’s of stuff but for my purpose I’ll just use it as a disassembler. It handles libcorona very well and kindly gives us the assembly code.</p>
<p><em>FYI: I picked the armeabi-v7a version so what follows would be different different with an apk targetting another platform</em></p>
<p>I look again for the string “resource.car” and find it referenced at offset 0x1081D4.</p>
<p>[caption id=”attachment_180” align=”aligncenter” width=”762”]<a href="/assets/archive/2015/02/res_car.png"><img src="/assets/archive/2015/02/res_car.png" alt="res_car"></a> The only piece of code referring to “resource.car”[/caption]</p>
<p>&nbsp;</p>
<p>It took me a while to figure out how things worked, but at some point i had a theory:<br>From the occurence of “resource.car”, I clearly see two execution paths: one that leads to a portion of code referencing the string <em>“could not verify”</em> and exiting, and one that leads to a subroutine that I deduced was meant to initialize the lua runtime or something like that. What stands between them is a fragile Branch No Equal (BNE) that we would like to turn into a rock solid Branch.</p>
<p>[caption id=”attachment_181” align=”aligncenter” width=”761”]<a href="/assets/archive/2015/02/jump_annot.png"><img src="/assets/archive/2015/02/jump_annot.png" alt="jump_annot"></a> Take the yellow jump to get to the blue subroutine and avoid the nasty red branches[/caption]</p>
<p>&nbsp;</p>
<p>Looking at <a href="http://bear.ces.cwru.edu/eecs_382/ARM7-TDMI-manual-pt2.pdf" target="_blank" rel="noopener">this document</a> and some other branch instructions around in the code, I deduced that I needed to change byte x108247 from 1A to EA to turn my BNE into a B. Going back to my hex editor (I should really learn how to use IDA properly some day) I change the aforementioned value.</p>
<p>[caption id=”attachment_182” align=”aligncenter” width=”715”]<a href="/assets/archive/2015/02/patched.png"><img src="/assets/archive/2015/02/patched.png" alt="patched"></a> It’s a branch![/caption]</p>
<p>&nbsp;</p>
<p>Now let’s pack our patched lib back into the apk, sign it, install it, run it… It runs! Let’s see if our custom value is used.</p>
<p>[caption id=”attachment_185” align=”aligncenter” width=”700”]<a href="/assets/archive/2015/02/modded.jpg"><img src="/assets/archive/2015/02/modded.jpg" alt="modded"></a> First time ever a guessed binary patch works upon first try.[/caption]</p>
<p>Let’s try the full pipeline: modify the lua source code, compile it, repack the .car and place it back in the .apk. It works provided we use the proper luac version (a quick search for the version string in liblua.so saves you the guessing). That’s it, the path is paved for hours of fun modding the game!</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>I had seen many game cheats and always wondered how they actually work, now I know at least for this one. To illustrate this article, I managed to strip all ads from the game, create a speed hack, fly mode, and unlimited powerups. Hacking the in-game money is harder because only the server issues coins, so even if you trick your phone into thinking you are rich, the server knows how much you really have.<br>I’d like to emphasis that I personally think buying or downloading a cheat for a game is lame and those who do that just deserve a trojan. However, hacking a game is really something fun that one should try. It requires patience, and a capability to keep a clear mind even after hours of work leading nowhere.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hmil.github.io/2015/02/00-hacking-funrun2-how-to-reverse-engineer-a-corona-app/" data-id="cjh6d84cb000el3yhdpftrql9" class="article-share-link">Share</a>
      
        <a href="https://hmil.github.io/2015/02/00-hacking-funrun2-how-to-reverse-engineer-a-corona-app/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/funrun/">funrun</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/funrun2/">funrun2</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hack/">hack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reverse-engineering/">reverse engineering</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-archive/sailsjs-tutorial-expenses-tracking-app-part-4" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-4/" class="article-date">
  <time datetime="2014-12-18T16:22:14.000Z" itemprop="datePublished">2014-12-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/archived/">archived</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-4/">SailsJS tutorial &amp;#124; expenses tracking app (Part 4/4)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-3" target="_blank" rel="noopener">In the previous parts</a>,<br>we’ve set up a sails application, added some styles and views and implemented a solid backend. It’s now time to finish this application. We will implement the front-end, adjust a few settings and give some tracks to continue the development.</p>
<h2 id="The-app-page"><a href="#The-app-page" class="headerlink" title="The app page"></a>The app page</h2><p>To render our app page, let’s open the MainController (in <em>api/controllers</em>) and replace the contents of the app action with<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">app: function (req, res) &#123;</span><br><span class="line">  res.view();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>What this does is it renders the view <em>views/main/app.ejs</em> because we are in the app action of the MainController. You should have already added this view in <a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-2" target="_blank" rel="noopener">part 2</a>.</p>
<p>Next we only want logged-in users to access our app so let’s add the following lines in <em>config/policies.js</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">MainController: &#123;</span><br><span class="line">  <span class="string">'app'</span>: [<span class="string">'passport'</span>, <span class="string">'sessionAuth'</span>]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>Also we want some more information about our users than we currently get, like their profile picture and full name. To do this, we’ll need to hack a bit into what sails-generate-auth generated us. Open <em>api/services/passport.js</em>, line 82 there’s the code fetching user attributes</p>
<p><pre lang="javascript" line="82"><br>  // If the profile object contains a list of emails, grab the first one and<br>  // add it to the user.<br>  if (profile.hasOwnProperty(‘emails’)) {<br>    user.email = profile.emails[0].value;<br>  }<br>  // If the profile object contains a username, add it to the user.<br>  if (profile.hasOwnProperty(‘username’)) {<br>    user.username = profile.username;<br>  }</pre></p>
<p>  // If neither an email or a username was available in the profile, we don’t<br>  // have a way of identifying the user in the future. Throw an error and let<br>  // whoever’s next in the line take care of it.<br>  if (!user.username &amp;&amp; !user.email) {<br>    return next(new Error(‘Neither a username nor email was available’));<br>  }</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">**Remove all this** and insert this instead:</span><br><span class="line">&lt;pre lang=&quot;javascript&quot; line=&quot;82&quot;&gt;</span><br><span class="line">  if (!profile.hasOwnProperty(&apos;id&apos;) </span><br><span class="line">      || !profile.hasOwnProperty(&apos;displayName&apos;)</span><br><span class="line">      || !profile.hasOwnProperty(&apos;photos&apos;)</span><br><span class="line">      || profile.photos.length == 0 ) &#123;</span><br><span class="line">    sails.log.error(&apos;not enough info&apos;);</span><br><span class="line">    next(new Error(&apos;Your login provider did not provide enough information.&apos;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  user.username = profile.displayName;</span><br><span class="line">  user.picture = profile.photos[0].value;</span><br></pre></td></tr></table></figure>
<h2 id="Scripting"><a href="#Scripting" class="headerlink" title="Scripting"></a>Scripting</h2><p>This tutorial aims to be neutral regarding what client technology you use, therefore we we’ll do DOM stuff “manually” with jquery and only use backbone and underscore to have a tidy collection of expenditures. You’ll be able to follow even if you’ve never heard of backbone.</p>
<p>First, <a href="http://hmil.fr/public/sails_tuto_1.zip" target="_blank" rel="noopener">download this archive</a>. It contains templates, js models and libs as well as a skeleton for our app script. Copy the assets into your assets folder.<br>You can lift your server and log-into the app. You should see a blank table. Now open your web console and it should display some errors. This is due to the fact that the script you just copied are linked to the layout in no particular order. You can see this by looking at <em>views/layout.ejs</em>.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;!--SCRIPTS--&gt;</span><br><span class="line">&lt;script src=<span class="string">"/js/dependencies/sails.io.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/dependencies/backbone.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/dependencies/bootstrap.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/dependencies/jquery-1.11.1.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/dependencies/perfect-scrollbar.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/dependencies/underscore.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/ExpenditureModel.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script src=<span class="string">"/js/app.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;!--SCRIPTS END--&gt;</span><br></pre></td></tr></table></figure></p>
<p>Here, backbone and bootstrap are included after jquery and underscore. To correct this, let’s take a look at <em>tasks/pipeline.js</em>. We will change <em>jsFilesToInject</em> such that our js files are included in the right order:</p>
<p><pre lang="javascript" line="24"><br>var jsFilesToInject = [<br>  // Underscore &amp; jquery before backbone<br>  ‘js/dependencies/jquery-1.11.1.js’,<br>  ‘js/dependencies/perfect-scrollbar.js’,<br>  ‘js/dependencies/underscore.js’,</pre></p>
<p>  // Dependencies like jQuery, or Angular are brought in here<br>  ‘js/dependencies/*<em>/</em>.js’,</p>
<p>  // The app classes before the app index<br>  ‘js/ExpenditureModel.js’,</p>
<p>  // All of the rest of your client-side js files<br>  // will be injected here in no particular order.<br>  ‘js/app.js’<br>];</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">While we are here, change _templateFilesToInject_ such that it looks for **.ejs** files instead of **.html**.</span><br><span class="line">&lt;pre lang=&quot;javascript&quot; line=&quot;51&quot;&gt;</span><br><span class="line">var templateFilesToInject = [</span><br><span class="line">  &apos;templates/**/*.ejs&apos;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>Save this file and if sails was running in background, the build tasks should run and now our js files should be included in the right order and our templates are compiled.</p>
<p>Now, let’s write real code. Open <em>assets/js/app.js</em>. This file contains already everything we need to handle the DOM of the page. What we’ll focus on is how to get data from the server and keep it in sync using Sails’ real-time capabilities. For simplicity we’ll do everything over the socket connection so that we don’t mix protocols.</p>
<p>We have a backbone expenditure collection that we’ll use to store our expenditures locally and propagate events.</p>
<p>First thing we’ll do is fetch a list of expenditures from the server. This is what <em>io.socket.get</em> is for.<br>Let’s add those models to our collection as soon as we get them.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">io.socket.get(<span class="string">'/expenditure'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">models</span>) </span>&#123;</span><br><span class="line">  expenditures.set(models, &#123;<span class="attr">parse</span>: <span class="literal">true</span>&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>We pass the <em>parse: true</em> option to turn the date string into an actual date object.<br>Add some expenditures with the shortcut routes (for instance <a href="http://localhost:1337/expenditure/create?amount=32&amp;description=resto" target="_blank" rel="noopener">/create?amount=32&amp;description=resto</a>) and now you should see them displayed in the table like this:</p>
<p><a href="/assets/archive/2014/12/sails-tuto-capture.png"><img src="/assets/archive/2014/12/sails-tuto-capture.png" alt="Yay, we got some data !"></a><br><em>If you can’t see the picture, that’s probably because you created a user before we told passport to get profile pictures of new users. Stop the server, delete <em>.tmp/localDiskDb.db</em>, then start the server again. Next time you log in, it will create a user from scratch and now your profile picture should be included with it.</em></p>
<p>Now it would be better if we could add expenditures directly from the app. We can insert the code that handles the create form submit action on line 58.</p>
<p><pre lang="javascript" line="58"><br>createForm.submit(formAction(createForm, function(formData) {<br>  io.socket.post(‘/expenditure’, formData, function(data, res) {<br>    if (res.statusCode === 201) {<br>      expenditures.add(new expenditures.model(data, {parse: true}));<br>    } else {<br>      console.log(data);<br>    }<br>  });<br>}));</pre></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Here we use the _post_ method of our socket to create the model, then we check the status code and create a new model if everything went fine. If there was an error, we just log the response body. It would be better to have a proper error handling mechanism of course but we won&apos;t do that in this tutorial.</span><br><span class="line"></span><br><span class="line">You can now see that our models are added to the collection and if you refresh they are still there. Good, now if you open a second tab it won&apos;t automatically update one tab while you add a model in the other. To do this, we need to fill the blank on line 23.</span><br><span class="line">This callback is invoked every time something changes in our expenditures collection. The passed-in _evt_ object has a _verb_ property which can take one of &quot;created&quot;, &quot;destroyed&quot;, &quot;updated&quot; values.</span><br><span class="line">With a simple switch, we can handle each of these cases:</span><br><span class="line">```javascript</span><br><span class="line"></span><br><span class="line">io.socket.on(&apos;expenditure&apos;, function(evt) &#123;</span><br><span class="line">  switch (evt.verb) &#123;</span><br><span class="line">    case &apos;created&apos;:</span><br><span class="line">      expenditures.add(evt.data, &#123;parse: true&#125;);</span><br><span class="line">      break;</span><br><span class="line">    case &apos;destroyed&apos;:</span><br><span class="line">      expenditures.remove(evt.id);</span><br><span class="line">      break;</span><br><span class="line">    case &apos;updated&apos;:</span><br><span class="line">      var data = _.extend(&#123;id: evt.id&#125;, evt.data)</span><br><span class="line">      expenditures.set(data, &#123; </span><br><span class="line">        parse: true, </span><br><span class="line">        remove: false </span><br><span class="line">      &#125;);</span><br><span class="line">      break;</span><br><span class="line">    default:</span><br><span class="line">      throw new Error(&quot;Unknown verb: &quot;+evt.verb);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>That’s all we need to make our app real-time !</p>
<p>Now how about deleting items. We have an event handler for that on what should now be line 48 and I think you’ve guessed what we’ll write here.</p>
<p><pre lang="javascript" line="48"><br>io.socket.delete(‘/expenditure/‘+id, function(data, res) {<br>  if (res.statusCode === 200) {<br>    expenditures.remove(id);<br>  } else {<br>    console.log(data);<br>  }<br>});</pre></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">And last but not least, we want to edit our records. This is done by clicking the edit icon which shows up a dialog. We need to write what happens when this dialog is submitted.</span><br><span class="line"></span><br><span class="line">```javascript</span><br><span class="line"></span><br><span class="line">$(&apos;#editModal-accept-btn&apos;).click(itemAction(function(evt) &#123;</span><br><span class="line">// Retrieve form data</span><br><span class="line">var formData = getFormData(editForm);</span><br><span class="line">var id = editedItem.id;</span><br><span class="line"></span><br><span class="line">// Save to the server</span><br><span class="line">io.socket.put(&apos;/expenditure/&apos;+id, formData, function(data, res) &#123;</span><br><span class="line">  // If successful</span><br><span class="line">  if (res.statusCode === 200) &#123;</span><br><span class="line">    // update the collection locally</span><br><span class="line">    var data = _.defaults(&#123;id: id&#125;, data);</span><br><span class="line">    expenditures.set(</span><br><span class="line">      data, </span><br><span class="line">      &#123;parse: true, remove: false&#125;</span><br><span class="line">    );</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    console.log(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>Congratulations, you now have a fully functionnal app !</strong></p>
<p>Now if you log-in as another user, the edit and delete actions are shown on expenditures you did not create. Of course, the server forbids this but it would be better if they were hidden. To do this, we’ll need to know which client is currently connected from the client-side javascript. The easiest way to do it is by adding a script in layout.ejs which injects a user object for the logged-in user in the client’s javascript scope. We need to be careful though as layout can be displayed even when the user is not logged in. Add this in <em>views/layout.ejs</em> right before the other scripts.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">  <span class="keyword">var</span> user = <span class="xml"><span class="tag">&lt;<span class="name">%-</span> <span class="attr">JSON.stringify</span>(<span class="attr">req.user</span>) || '<span class="attr">null</span>' %&gt;</span>;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>Now we can use this client object in our client-side scripts. Let’s edit <em>assets/templates/expenditureItem.ejs</em>, we will wrap the actions in an if statement like this:</p>
<p><pre lang="javascript" line="14"><br>&lt;% // person is available as a template variable. user is taken from the global scope<br> if (person.id === user.id) { %&gt;<br>  [“&gt;</pre></p>
<p>  ](#)<br>  [“&gt;</p>
<p>  ](#)<br>&lt;% } %&gt;</p>
<p><code>`</code></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>From there, if you want to use mongodb as your data store, the only thing you need to do is put your configuration in <em>config/connections.js</em> and set that connection in <em>config/model.js</em>. I think it’s a really great framework with powerful features despite the fact it currently lacks contributors (and documentation). </p>
<p>I hope this tutorial gave you a good insight at how Sails works and that you’ll have fun building awesome app with it! Feel free to ask any question on <a href="https://twitter.com/HadrienMilano" target="_blank" rel="noopener">twitter</a> or add a comment below.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hmil.github.io/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-4/" data-id="cjh6d84dj0021l3yh4w0mbs3r" class="article-share-link">Share</a>
      
        <a href="https://hmil.github.io/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-4/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-archive/sailsjs-tutorial-expenses-tracking-app-part-3" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-3/" class="article-date">
  <time datetime="2014-12-10T08:50:36.000Z" itemprop="datePublished">2014-12-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/archived/">archived</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-3/">SailsJS tutorial &amp;#124; expenses tracking app (Part 3/4)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-2" target="_blank" rel="noopener">Previously</a> in SailsJS tutorial:</p>
<ul>
<li>We created a Sails app and added authentication with passport</li>
<li>We added our styles and less without worrying about compilation and linking</li>
<li>We implemented a basic layout that shows the user’s login status<br>To be fair, the two last parts were actually pretty boring. But now comes the real fun: generating models and APIs. This is something Sails excels at and we’ll really feel like we are building something fast!</li>
</ul>
<h2 id="Generating-models-and-APIs"><a href="#Generating-models-and-APIs" class="headerlink" title="Generating models and APIs"></a>Generating models and APIs</h2><p>When we used <a href="https://www.npmjs.org/package/sails-generate-auth" target="_blank" rel="noopener">sails-generate-auth</a>, we already created a User model. Now the fundamental model for an expenditures tracking app is… guess what ? Expenditures!<br>They have the following attributes: </p>
<ul>
<li>an amount to see how much was spent</li>
<li>a date to sort them chronologically</li>
<li>the person who paid</li>
<li>and a description to remember what it was for<br>Remember: we do not model money exchange, as in “Alice paid XX$ to Bob”. Instead we model individual losses and earnings like this : “Alice spent XX$. Bob earned XX$” (it takes two records instead of one). It looks cumbersome for a group of two but for larger groups it performs better because a user doesn’t need to keep track of his debts for each individual person. Instead there’s just one number to sum everything up.</li>
</ul>
<p>Anyway, let’s get back to our expenditures model. We will generate it using the command line tool<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sails generate api expenditure</span><br></pre></td></tr></table></figure></p>
<p>This generates an empty Expenditure model and an empty ExpenditureController controller under <em>api/</em>.</p>
<p>It may seem quite useless but there’s actually a lot going on already. To demonstrate this, let’s just <em>lift</em> the server. Navigate to localhost:1337/expenditure and you see an empty JSON array. Try browsing to /expenditure/create?amount=39&amp;description=foobar then get back to /expenditure. You just created a model!<br>You can update your model similarly by navigating to /expenditure/update/:id/? where <em>:id</em> is the id of your model and passing similar arguments as for create. You can destroy a model with <em>/expenditure/destroy/:id/</em><br>Play around with it a little to get familiar and come back when you are done.</p>
<p><em>A quick note on security: these routes (/create, /update, /destroy) should <strong>never be used in production</strong>. They can be disabled by setting the property <em>shortcut: false</em> in <em>config/blueprints.js</em>. They are called shortcuts for it allows a developer to easily test his api but it is not meant to be used _by_ the app. The reason is, a crawler could find such url and visit it, thinking it will find a page but instead it will start messing with your data!</em></p>
<p>The right way to use the api is by using the appropriate HTTP terms (GET, POST, PUT, DELETE) like you’d do with <a href="http://backbonejs.org/#Sync" target="_blank" rel="noopener">backbonejs</a>.<br>But, since sails is awesome, they built something special for you. If you go back to your homepage and open the web console, you see that Sails opens a websocket connection automatically. This socket can be used to perform queries. Instead of using classic HTTP queries, you can use io.socket.(get|post|put|delete). It has the same effect but <strong>acts through the socket.io connection!</strong><br>Try the following in your web console. It should create a model then display the list of expenditures and finally destroy the first one it finds:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">io.socket.post(<span class="string">'/expenditure'</span>, &#123;<span class="attr">amount</span>: <span class="number">42</span>, <span class="attr">description</span>: <span class="string">"bought the hitchhiker's guide"</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  io.socket.get(<span class="string">'/expenditure'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">expenditures</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(expenditures);</span><br><span class="line">    io.socket.delete(<span class="string">'/expenditure/'</span>+expenditures[<span class="number">0</span>].id);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>Great, we wrote nothing and have a fully working REST API. It does a lot of things including things we don’t want. The fun thing here is that building an API with Sails consists mostly in having it <em>not do what we don’t want it to do</em> rather than trying to make it do things.</p>
<h2 id="The-API-under-control"><a href="#The-API-under-control" class="headerlink" title="The API under control!"></a>The API under control!</h2><p>Let’s begin by defining model attributes as well as their types. This way we will force our records to conform to some predefined schema.<br>In config/model.js, add the line <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">schema: <span class="literal">true</span></span><br><span class="line"><span class="string">``</span><span class="string">`. This tells sails that it must follow strictly the schemas we are about to define.</span></span><br><span class="line"><span class="string">Now in models/Expenditure.js, insert the following code to define the attributes we talked about earlier:</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line"></span><br><span class="line">  attributes: &#123;</span><br><span class="line">    person    : &#123; </span><br><span class="line">      model: <span class="string">'user'</span>,</span><br><span class="line">      required: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    amount    : &#123; </span><br><span class="line">      type: <span class="string">'integer'</span>, </span><br><span class="line">      required: <span class="literal">true</span> </span><br><span class="line">    &#125;,</span><br><span class="line">    date      : &#123; </span><br><span class="line">      type: <span class="string">'date'</span>, </span><br><span class="line">      required: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    description: &#123; </span><br><span class="line">      type: <span class="string">'string'</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>Also we will want our Users to have a picture attribute. To do this, add a picture attribute of type string. Your User model should look like this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> User = &#123;</span><br><span class="line">  <span class="comment">// Enforce model schema in the case of schemaless databases</span></span><br><span class="line">  schema: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  attributes: &#123;</span><br><span class="line">    username  : &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    picture   : &#123; <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">    passports : &#123; <span class="attr">collection</span>: <span class="string">'Passport'</span>, <span class="attr">via</span>: <span class="string">'user'</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><em>Note that the ‘schema: true’ attribute is optional now that we defined it in the global configuration.</em></p>
<p>Now you can restart the server and if you try to insert nonsense in the database, Sails won’t let you anymore.</p>
<p>Next, we’ll add some policies such that only logged in users can access the expenditures API.</p>
<p>In <em>api/policies/sessionAuth.js</em> replace the <em>req.session.authenticated</em> with <em>req.isAuthenticated()</em>. It should look like this now<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (req.isAuthenticated()) &#123;</span><br><span class="line">    <span class="keyword">return</span> next();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// User is not allowed</span></span><br><span class="line">  <span class="keyword">return</span> res.redirect(<span class="string">'/login'</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>We will also add a custom policy to check when a user owns an expenditure record.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// api/policies/ownsExpenditure.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!req.isAuthenticated()) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.forbidden();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Expenditure.findOne(req.param(<span class="string">'id'</span>)).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, exp</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) next(err);</span><br><span class="line">    <span class="keyword">if</span> (req.user.id === exp.person) &#123;</span><br><span class="line">      <span class="keyword">return</span> next();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res.forbidden();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>To apply these policies, open <em>config/policies.js</em> and define how policies should be applied like this:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">ExpenditureController: &#123;</span><br><span class="line">  <span class="string">'*'</span>:      [<span class="string">'passport'</span>, <span class="string">'ownsExpenditure'</span>],</span><br><span class="line">  <span class="string">'find'</span>:   [<span class="string">'passport'</span>, <span class="string">'sessionAuth'</span>],</span><br><span class="line">  <span class="string">'create'</span>: [<span class="string">'passport'</span>, <span class="string">'sessionAuth'</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ... */</span></span><br></pre></td></tr></table></figure></p>
<p>We allow <em>find</em> and <em>create</em> actions to anyone who is authenticated. Every other action can only be performed by someone who owns the target expenditure. Note that ownsExpenditure also checks that the user is authenticated so we don’t need to apply the <em>sessionAuth</em> policy in this case.</p>
<p>All right, now our app is a little more secure. But we are still taking user input as is without doing any verification on it. We need to implement the create action ourselves, this way we can manipulate user input before it is saved to our DB. The following code does exactly what the automagic action was doing for us before but in addition it also cleans the user input before feeding it to the model. Take a few minutes to understand exactly what happens here:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// api/controllers/ExpenditureController.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  create: <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get only the attributes we want and apply defaults</span></span><br><span class="line">    <span class="keyword">var</span> data = &#123;</span><br><span class="line">      description: req.param(<span class="string">'description'</span>),</span><br><span class="line">      amount: req.param(<span class="string">'amount'</span>),</span><br><span class="line">      <span class="comment">// The user is taken directly from the request element. This is what</span></span><br><span class="line">      <span class="comment">// passport gives us and the user cannot easily spoof this information</span></span><br><span class="line">      person: req.user,</span><br><span class="line">      <span class="comment">// Parse the provided date or use current date if none is provided</span></span><br><span class="line">      date: req.param(<span class="string">'date'</span>) != <span class="literal">null</span> ? <span class="keyword">new</span> <span class="built_in">Date</span>(req.param(<span class="string">'date'</span>)) : <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create new instance of model using data from params</span></span><br><span class="line">    Expenditure.create(data).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> next(err);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The data field returned does not contain a fully populated</span></span><br><span class="line">      <span class="comment">// person attribute so we use the one at our disposal (req.user) to continue</span></span><br><span class="line">      <span class="keyword">var</span> expenditure = _.extend(data, &#123;<span class="attr">person</span>: req.user&#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// You can always use this boolean to check if the request was issued on a</span></span><br><span class="line">      <span class="comment">// socket or standard HTTP request</span></span><br><span class="line">      <span class="keyword">if</span> (req.isSocket) &#123;</span><br><span class="line">        <span class="comment">// Subscribe the current socket</span></span><br><span class="line">        Expenditure.subscribe(req, expenditure);</span><br><span class="line">        <span class="comment">// Introduce all class listeners to this instance</span></span><br><span class="line">        Expenditure.introduce(expenditure);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Tell everyone listening that a model was created</span></span><br><span class="line">      Expenditure.publishCreate(expenditure, req);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// (HTTP 201: Created)</span></span><br><span class="line">      res.status(<span class="number">201</span>).send(expenditure.toJSON());</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></p>
<p>Now when a user is logged in and sends a request to create an expenditure, the model gets properly populated with the right ‘person’ attribute. </p>
<p>Your API is now complete! The last thing we are left with is implementing a front-end and we’ll be done. You may have noticed though that we did not override the update method. Therefore someone could still insert stupid data in our database. As an exercise, you can try implementing the update method such that it filters user input before inserting it in the database. You could start from the <a href="https://github.com/balderdashy/sails/blob/master/lib/hooks/blueprints/actions/update.js" target="_blank" rel="noopener">blueprint implementation</a>. It contains many comments and it is a good way to learn more about sails and how it works.</p>
<p><a href="http://blog.hmil.fr/2014/12/sailsjs-tutorial-expenses-tracking-app-part-4" target="_blank" rel="noopener"><strong>In the next part</strong></a>, we’ll write a front-end for our sailsjs app.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://hmil.github.io/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-3/" data-id="cjh6d84df001vl3yhvgqkrnmu" class="article-share-link">Share</a>
      
        <a href="https://hmil.github.io/2014/12/archive/sailsjs-tutorial-expenses-tracking-app-part-3/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/archived/">archived</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hacking/">hacking</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/random/">random</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/software-engineering/">software engineering</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/GitHub/" style="font-size: 10px;">GitHub</a> <a href="/tags/TypeScript/" style="font-size: 20px;">TypeScript</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/architecture/" style="font-size: 15px;">architecture</a> <a href="/tags/funrun/" style="font-size: 10px;">funrun</a> <a href="/tags/funrun2/" style="font-size: 10px;">funrun2</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/hack/" style="font-size: 10px;">hack</a> <a href="/tags/monorepo/" style="font-size: 15px;">monorepo</a> <a href="/tags/reverse-engineering/" style="font-size: 10px;">reverse engineering</a> <a href="/tags/satire/" style="font-size: 10px;">satire</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/05/The-github-etiquette/">How not to suck at GitHub</a>
          </li>
        
          <li>
            <a href="/2018/05/TypeScript-project-structure2/">How to manage and publish a multi-package TypeScript project</a>
          </li>
        
          <li>
            <a href="/2018/03/TypeScript-project-structure/">Tips and tricks to structure multi-package TypeScript projects</a>
          </li>
        
          <li>
            <a href="/2017/08/archive/deal-with-nullables-like-theyre-not-even-here-good-coding-practices-in-typescript/">Deal with nullables like they&#39;re not even here - Good coding practices in TypeScript.</a>
          </li>
        
          <li>
            <a href="/2016/10/archive/you-should-worry-about-vary/">You should worry about Vary</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Hadrien Milano<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'hmil';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>